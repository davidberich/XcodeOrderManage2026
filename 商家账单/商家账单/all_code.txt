

// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/PhotoSaver.swift
// ==========================================

// PhotoSaver.swift
import UIKit

// <<< 核心修改：将 PhotoSaver 改为单例模式
class PhotoSaver: NSObject {
    // 1. 创建一个静态的共享实例
    static let shared = PhotoSaver()
    
    // 2. 将回调闭包作为属性，以便可以从外部设置
    var onSuccess: (() -> Void)?
    var onError: ((Error?) -> Void)?
    
    // 3. 将 init 设为私有，防止外部创建新的实例
    private override init() {
        super.init()
    }

    func save(image: UIImage, onSuccess: @escaping () -> Void, onError: @escaping (Error?) -> Void) {
        // 4. 在调用时直接设置回调，而不是依赖预设的属性
        self.onSuccess = onSuccess
        self.onError = onError
        
        // 5. 调用系统函数，并将 self（这个单例对象）作为回调目标
        UIImageWriteToSavedPhotosAlbum(image, self, #selector(saveCompleted), nil)
    }

    @objc private func saveCompleted(_ image: UIImage, didFinishSavingWithError error: Error?, contextInfo: UnsafeRawPointer) {
        if let error = error {
            onError?(error)
        } else {
            onSuccess?()
        }
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/NewOrderView.swift
// ==========================================

// NewOrderView.swift

import SwiftUI

struct OrderItemRowSummary: View {
    let item: OrderItem
    var showPriceInfo: Bool = true
    var onEdit: (() -> Void)?

    var body: some View {
        HStack(alignment: .top, spacing: 12) {
            if let firstImageId = item.productImageIdentifiers.first,
               let uiImage = ImageStore.shared.loadImage(withIdentifier: firstImageId) {
                Image(uiImage: uiImage).resizable().scaledToFill().frame(width: 80, height: 80).cornerRadius(8).clipped()
            } else {
                RoundedRectangle(cornerRadius: 8).fill(Color.gray.opacity(0.1)).frame(width: 80, height: 80).overlay(Image(systemName: "photo").foregroundColor(.gray))
            }
            
            VStack(alignment: .leading, spacing: 8) {
                Text(item.productName)
                    .font(.title3.weight(.medium))
                
                Text("\(item.color) / \(item.leather)")
                    .font(.callout)
                    .foregroundColor(.secondary)
                
                if showPriceInfo {
                    if item.unitPrice <= 0 {
                        Text("数量: \(item.totalItemQuantity), 单价待定")
                            .font(.callout)
                            .foregroundColor(.red)
                    } else {
                        Text("数量: \(item.totalItemQuantity), 单价: ¥\(String(format: "%.2f", item.unitPrice))")
                            .font(.callout)
                    }
                } else {
                    Text("数量: \(item.totalItemQuantity)")
                        .font(.callout)
                }
            }
            
            Spacer()
            
            VStack(alignment: .trailing) {
                if let onEdit = onEdit {
                    Button(action: onEdit) {
                        Image(systemName: "square.and.pencil")
                            .font(.title2)
                    }
                    .buttonStyle(.borderless)
                }
                
                if showPriceInfo {
                    Spacer()
                    if item.totalItemPrice <= 0 {
                        Text("待定")
                            .font(.callout)
                            .fontWeight(.medium)
                            .foregroundColor(.red)
                    } else {
                        Text("¥\(String(format: "%.2f", item.totalItemPrice))")
                            .font(.callout)
                            .fontWeight(.medium)
                    }
                }
            }
        }
        .padding(.vertical, 5)
    }
}


struct NewOrderView: View {
    @StateObject private var viewModel = NewOrderViewModel()
    @EnvironmentObject var mainViewModel: OrderViewModel
    @Environment(\.presentationMode) var presentationMode

    @State private var showingFactoryOrderSelection = false
    @FocusState private var focusedField: FocusField?
    enum FocusField { case customerName }

    var body: some View {
        NavigationView {
            Form {
                customerInfoSection
                orderItemsSection
                orderSummarySection
                logisticsSection
                factoryOrderButtonSection
            }
            .navigationTitle("创建新订单")
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) { Button("取消", role: .cancel, action: cancelCreation) }
                ToolbarItem(placement: .navigationBarTrailing) { Button("保存", action: saveOrder).disabled(!viewModel.isSaveEnabled) }
                ToolbarItemGroup(placement: .keyboard) { Spacer(); Button("完成") { focusedField = nil } }
            }
            .sheet(isPresented: $viewModel.itemSheetIsPresented) {
                AddOrderItemView(item: $viewModel.itemForEditing) { savedItem in
                    viewModel.saveItem(savedItem)
                }
            }
            .sheet(isPresented: $showingFactoryOrderSelection) {
                let tempOrder = Order(orderNumber: "临时", customerName: viewModel.customerName, date: Date(), orderItems: viewModel.orderItems, urgency: viewModel.urgency, customerType: viewModel.customerType, trademark: viewModel.trademark, shipmentStatus: viewModel.shipmentStatus)
                NavigationView {
                    FactoryItemSelectionView(order: tempOrder)
                }
            }
        }
    }
    
    // MARK: - Sections
    private var customerInfoSection: some View {
        Section(header: Text("客户信息")) {
            TextField("客户名称*", text: $viewModel.customerName).focused($focusedField, equals: .customerName)
            Picker("客户类型", selection: $viewModel.customerType) {
                ForEach(CustomerType.allCases) { Text($0.displayTitle).tag($0) }
            }.pickerStyle(.segmented)
            Picker("订单速度", selection: $viewModel.urgency) {
                ForEach(OrderUrgency.allCases) { Text($0.displayTitle).tag($0) }
            }.pickerStyle(.segmented)
            Picker("商标", selection: $viewModel.trademark) {
                ForEach(TrademarkOption.allCases) { Text($0.displayTitle).tag($0) }
            }.pickerStyle(.segmented)
        }
    }
    
    private var orderItemsSection: some View {
        Section(header: Text("商品列表")) {
            ForEach(viewModel.orderItems) { item in
                OrderItemRowSummary(item: item, onEdit: { viewModel.prepareToEdit(item) })
            }
            .onDelete(perform: viewModel.deleteItem)
            
            Button(action: { viewModel.prepareNewItem() }) {
                Label("添加商品", systemImage: "plus")
            }
        }
    }

    private var orderSummarySection: some View {
        Section(header: Text("订单总览")) {
            HStack { Text("商品总数:"); Spacer(); Text("\(viewModel.totalQuantity) 件") }
            HStack {
                Text("订单总金额:").fontWeight(.medium)
                Spacer()
                Text("¥\(String(format: "%.2f", viewModel.totalPrice))")
                    .fontWeight(.semibold)
                    .foregroundColor(viewModel.hasPendingPrice ? .red : .primary)
                if viewModel.hasPendingPrice {
                    Text("(单价待定)").font(.caption).foregroundColor(.red)
                }
            }
        }
    }
    
    private var logisticsSection: some View {
        // <--- 修改点
        Section(header: Text("物流信息")) {
            Picker("发货状态", selection: $viewModel.shipmentStatus) {
                ForEach(ShipmentStatus.allCases) { status in
                    Text(status.displayTitle).tag(status)
                }
            }
            .pickerStyle(.segmented)
        }
    }
    
    private var factoryOrderButtonSection: some View {
        Section {
            Button(action: { showingFactoryOrderSelection = true }) {
                HStack {
                    Spacer()
                    Image(systemName: "doc.text.fill")
                    Text("生成工厂订单").fontWeight(.semibold)
                    Spacer()
                }
            }
            .buttonStyle(FactoryOrderButtonStyle())
            .disabled(!viewModel.isFactoryOrderEnabled)
            .listRowInsets(EdgeInsets())
        }
    }
    
    // MARK: - Actions
    private func saveOrder() {
        _ = viewModel.saveOrder(in: mainViewModel)
        presentationMode.wrappedValue.dismiss()
    }
    
    private func cancelCreation() {
        viewModel.cleanupImagesOnCancel()
        presentationMode.wrappedValue.dismiss()
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/TrashView.swift
// ==========================================

// TrashView.swift
// 已修复编译器无法在合理时间内完成类型检查的错误，并优化了视图结构

import SwiftUI

struct TrashView: View {
    @EnvironmentObject var viewModel: OrderViewModel
    @EnvironmentObject var userSettings: UserSettings // <<< 修复点1: 添加 UserSettings >>>
    @Environment(\.presentationMode) var presentationMode

    @Namespace private var trashNamespace
    
    @State private var orderToDelete: Order?
    @State private var showingDeleteConfirm = false

    var body: some View {
        // <<< 修复点2: 将 GeometryReader 移到最外层 >>>
        GeometryReader { geometry in
            NavigationView {
                // 将主要内容提取到 mainContent() 中
                mainContent(screenWidth: geometry.size.width)
                    .navigationTitle("垃圾桶 (\(viewModel.deletedOrders.count))")
                    .toolbar {
                        ToolbarItem(placement: .navigationBarTrailing) {
                            Button("关闭") { presentationMode.wrappedValue.dismiss() }
                        }
                    }
                    .alert("确认永久删除", isPresented: $showingDeleteConfirm, presenting: orderToDelete) { order in
                        Button("永久删除", role: .destructive) {
                            viewModel.permanentlyDeleteOrdersFromTrash(ids: [order.id])
                            self.orderToDelete = nil
                        }
                        Button("取消", role: .cancel) {
                            self.orderToDelete = nil
                        }
                    } message: { order in
                        Text("你确定要永久删除客户“\(order.customerName)”的这份订单吗？此操作无法撤销，所有相关图片也会被删除。")
                    }
            }
        }
    }
    
    // MARK: - 辅助视图构建器
    
    // <<< 修复点3: 将主要内容封装成一个私有函数 >>>
    @ViewBuilder
    private func mainContent(screenWidth: CGFloat) -> some View {
        VStack {
            if viewModel.deletedOrders.isEmpty {
                emptyStateView
            } else {
                orderListView(screenWidth: screenWidth)
            }
        }
    }
    
    // <<< 修复点4: 将 List 及其内容也封装起来 >>>
    @ViewBuilder
    private func orderListView(screenWidth: CGFloat) -> some View {
        List {
            ForEach(viewModel.deletedOrders) { order in
                TrashOrderRow(
                    order: order,
                    screenWidth: screenWidth,
                    namespace: trashNamespace,
                    onRestore: {
                        viewModel.restoreOrdersFromTrash(ids: [order.id])
                    },
                    onDelete: {
                        self.orderToDelete = order
                        self.showingDeleteConfirm = true
                    }
                )
            }
        }
        .listStyle(.plain)
    }
    
    @ViewBuilder
    private var emptyStateView: some View {
        VStack(spacing: 20) {
            Spacer()
            Image(systemName: "trash.slash.fill")
                .font(.system(size: 70))
                .foregroundColor(.secondary)
            Text("垃圾桶是空的")
                .font(.title.bold())
            Spacer()
            Spacer()
        }
        .frame(maxWidth: .infinity)
    }
}


// <<< 修复点5: 创建一个专门的行项目视图，包含其所有逻辑 >>>
private struct TrashOrderRow: View {
    @EnvironmentObject var userSettings: UserSettings
    
    let order: Order
    let screenWidth: CGFloat
    let namespace: Namespace.ID
    let onRestore: () -> Void
    let onDelete: () -> Void
    
    var body: some View {
        ZStack(alignment: .topTrailing) {
            OrderRowView(
                order: order,
                screenWidth: screenWidth,
                fontScaleMultiplier: userSettings.fontScaleMultiplier,
                onImageTapped: { _ in },
                namespace: namespace
            )
            .saturation(0)
            
            statusTag(text: "垃圾桶", color: .white, backgroundColor: .gray)
                .padding([.top, .trailing], 6)
        }
        .padding(.horizontal)
        .listRowInsets(EdgeInsets(top: 5, leading: 0, bottom: 5, trailing: 0))
        .listRowSeparator(.hidden)
        .swipeActions(edge: .leading, allowsFullSwipe: true) {
            Button(action: onRestore) {
                Label("恢复订单", systemImage: "arrow.uturn.backward.circle.fill")
            }
            .tint(.green)
        }
        .swipeActions(edge: .trailing, allowsFullSwipe: false) {
            Button(role: .destructive, action: onDelete) {
                Label("永久删除", systemImage: "trash.fill")
            }
        }
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/ImageStore.swift
// ==========================================

import SwiftUI
import Foundation
import Photos

class ImageStore {
    static let shared = ImageStore()
    private let fileManager = FileManager.default
    private let documentsDirectory: URL

    private init() {
        documentsDirectory = fileManager.urls(for: .documentDirectory, in: .userDomainMask).first!
    }
    
    // 获取图片在沙盒中的URL
    func urlForImage(with identifier: String) -> URL? {
        let imagePath = documentsDirectory.appendingPathComponent("\(identifier).jpg")
        return fileManager.fileExists(atPath: imagePath.path) ? imagePath : nil
    }

    // 从一个源URL复制图片到沙盒
    func copyImage(from sourceURL: URL, withName fileName: String) throws {
        let destinationURL = documentsDirectory.appendingPathComponent(fileName)
        
        if fileManager.fileExists(atPath: destinationURL.path) {
            try fileManager.removeItem(at: destinationURL)
        }
        
        try fileManager.copyItem(at: sourceURL, to: destinationURL)
    }

    func saveImage(_ image: UIImage, withIdentifier identifier: String? = nil) -> String? {
        guard let data = image.jpegData(compressionQuality: 0.8) else {
            print("ImageStore: Could not get JPEG data from image.")
            return nil
        }
        let uniqueID = identifier ?? UUID().uuidString
        let imagePath = documentsDirectory.appendingPathComponent("\(uniqueID).jpg")
        do {
            try data.write(to: imagePath)
            return uniqueID
        } catch {
            print("ImageStore: Error saving image to sandbox: \(error.localizedDescription)")
            return nil
        }
    }

    func loadImage(withIdentifier identifier: String) -> UIImage? {
        let imagePath = documentsDirectory.appendingPathComponent("\(identifier).jpg")
        guard fileManager.fileExists(atPath: imagePath.path) else { return nil }
        return UIImage(contentsOfFile: imagePath.path)
    }

    func deleteImage(withIdentifier identifier: String) {
        let imagePath = documentsDirectory.appendingPathComponent("\(identifier).jpg")
        guard fileManager.fileExists(atPath: imagePath.path) else { return }
        do {
            try fileManager.removeItem(at: imagePath)
        } catch {
            print("ImageStore: Error deleting image from sandbox: \(error.localizedDescription)")
        }
    }

    func deleteImages(withIdentifiers identifiers: [String]) {
        for id in identifiers {
            deleteImage(withIdentifier: id)
        }
    }

    func saveToPhotoLibrary(_ image: UIImage, completion: @escaping (Bool, Error?) -> Void) {
        PHPhotoLibrary.requestAuthorization(for: .readWrite) { status in
            guard status == .authorized || status == .limited else {
                let error = NSError(
                    domain: "PhotoLibraryAccess", code: 1,
                    userInfo: [NSLocalizedDescriptionKey: "App does not have permission to access the photo library."]
                )
                DispatchQueue.main.async {
                    completion(false, error)
                }
                return
            }
            
            PHPhotoLibrary.shared().performChanges({
                PHAssetChangeRequest.creationRequestForAsset(from: image)
            }) { success, error in
                DispatchQueue.main.async {
                    completion(success, error)
                }
            }
        }
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/BackupAndRestoreView.swift
// ==========================================

import SwiftUI
import UniformTypeIdentifiers
import ZIPFoundation

struct BackupAndRestoreView: View {
    @EnvironmentObject var viewModel: OrderViewModel
    @Environment(\.presentationMode) var presentationMode
    
    // 使用独立的 Bool 状态变量
    @State private var isShowingExporter = false
    @State private var isShowingImporter = false
    @State private var showResultAlert = false
    
    @State private var backupFileURL: URL?
    
    @State private var alertTitle = ""
    @State private var alertMessage = ""
    
    @State private var isProcessing = false

    var body: some View {
        NavigationView {
            Form {
                // UI 布局保持不变
                Section(
                    header: Text("数据备份 (含图片)"),
                    footer: Text("将所有订单数据和相关图片打包成一个 .zip 文件。请将此文件妥善保管，用于恢复或迁移数据。")
                ) {
                    Button(action: createBackup) {
                        HStack {
                            Label("创建并导出完整备份", systemImage: "archivebox.circle.fill")
                            if isProcessing {
                                Spacer()
                                ProgressView()
                            }
                        }
                    }
                    .disabled(viewModel.orders.isEmpty || isProcessing)
                }
                
                Section(
                    header: Text("数据恢复"),
                    footer: Text("从一个 .zip 备份文件中恢复订单和图片。App会自动跳过已存在的重复订单。")
                ) {
                    Button(action: { isShowingImporter = true }) {
                        Label("从备份文件导入", systemImage: "square.and.arrow.down")
                    }
                    .disabled(isProcessing)
                }
            }
            .navigationTitle("备份与恢复")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("完成") { presentationMode.wrappedValue.dismiss() }
                }
            }
            .sheet(isPresented: $isShowingExporter, onDismiss: {
                if let url = backupFileURL {
                    try? FileManager.default.removeItem(at: url)
                }
            }) {
                if let url = backupFileURL {
                    ShareSheet(activityItems: [url])
                }
            }
            .fileImporter(isPresented: $isShowingImporter, allowedContentTypes: [UTType.zip]) { result in
                handleImport(result: result)
            }
            .alert(alertTitle, isPresented: $showResultAlert) {
                Button("好的", role: .cancel) {}
            } message: {
                Text(alertMessage)
            }
        }
    }
    
    private func createBackup() {
        isProcessing = true
        Task(priority: .userInitiated) {
            do {
                let url = try await packageBackupInBackground()
                await MainActor.run {
                    self.backupFileURL = url
                    self.isProcessing = false
                    self.isShowingExporter = true
                }
            } catch {
                await MainActor.run {
                    self.alertTitle = "备份失败"
                    self.alertMessage = error.localizedDescription
                    self.isProcessing = false
                    self.showResultAlert = true
                }
            }
        }
    }
    
    // ✅ 修复：将 handleImport 函数的实现修正为使用正确的状态变量
    private func handleImport(result: Result<URL, Error>) {
        isProcessing = true
        guard case .success(let zipURL) = result else {
            if case .failure(let error) = result {
                self.alertTitle = "导入失败"
                self.alertMessage = "无法选择文件: \(error.localizedDescription)"
                self.showResultAlert = true
            }
            isProcessing = false
            return
        }
        
        guard zipURL.startAccessingSecurityScopedResource() else {
            self.alertTitle = "导入失败"
            self.alertMessage = "无法访问所选文件，请检查文件权限。"
            self.showResultAlert = true
            isProcessing = false
            return
        }
        
        Task(priority: .userInitiated) {
            let fileManager = FileManager.default
            let extractionDirectory = fileManager.temporaryDirectory.appendingPathComponent("OrderBackup-\(UUID().uuidString)")
            
            var finalAlertTitle: String
            var finalAlertMessage: String
            
            do {
                try fileManager.createDirectory(at: extractionDirectory, withIntermediateDirectories: true, attributes: nil)
                try fileManager.unzipItem(at: zipURL, to: extractionDirectory)
                
                guard let jsonURL = findFile(named: "app_orders.json", in: extractionDirectory) else {
                    throw NSError(domain: "ImportError", code: 404, userInfo: [NSLocalizedDescriptionKey: "在备份文件中找不到订单数据(app_orders.json)。"])
                }

                let data = try Data(contentsOf: jsonURL)
                let decoder = JSONDecoder()
                var importedOrders = try decoder.decode([Order].self, from: data)
                
                for i in 0..<importedOrders.count {
                    if importedOrders[i].status == nil { importedOrders[i].status = .active }
                }
                
                let imagesSourceDir = jsonURL.deletingLastPathComponent().appendingPathComponent("Images")
                if fileManager.fileExists(atPath: imagesSourceDir.path) {
                    let imageFiles = try fileManager.contentsOfDirectory(at: imagesSourceDir, includingPropertiesForKeys: nil)
                    for imageURL in imageFiles {
                        try ImageStore.shared.copyImage(from: imageURL, withName: imageURL.lastPathComponent)
                    }
                }
                
                let mergeResult = await MainActor.run {
                    viewModel.mergeImportedOrders(importedOrders)
                }
                finalAlertTitle = "恢复完成"
                finalAlertMessage = "成功导入 \(mergeResult.importedCount) 条新订单。\n跳过 \(mergeResult.skippedCount) 条重复订单。"
                
            } catch {
                finalAlertTitle = "导入失败"
                finalAlertMessage = error.localizedDescription
            }
            
            zipURL.stopAccessingSecurityScopedResource()
            try? fileManager.removeItem(at: extractionDirectory)
            
            await MainActor.run {
                self.alertTitle = finalAlertTitle
                self.alertMessage = finalAlertMessage
                self.showResultAlert = true
                self.isProcessing = false
            }
        }
    }

    private func findFile(named fileName: String, in directory: URL) -> URL? {
        let enumerator = FileManager.default.enumerator(at: directory, includingPropertiesForKeys: [.nameKey], options: [.skipsHiddenFiles])
        
        while let fileURL = enumerator?.nextObject() as? URL {
            if fileURL.lastPathComponent == fileName {
                return fileURL
            }
        }
        return nil
    }

    private func packageBackupInBackground() async throws -> URL {
        let fileManager = FileManager.default
        let tempDirectory = fileManager.temporaryDirectory.appendingPathComponent(UUID().uuidString)
        try fileManager.createDirectory(at: tempDirectory, withIntermediateDirectories: true, attributes: nil)
        
        await viewModel.saveOrders()
        let jsonSourceURL = viewModel.ordersFileURL
        let jsonDestinationURL = tempDirectory.appendingPathComponent("app_orders.json")
        if fileManager.fileExists(atPath: jsonSourceURL.path) {
            try fileManager.copyItem(at: jsonSourceURL, to: jsonDestinationURL)
        }
        
        let imagesDirectory = tempDirectory.appendingPathComponent("Images")
        let allImageIDs = Set(viewModel.orders.flatMap { $0.orderItems.flatMap { $0.productImageIdentifiers } })
        
        if !allImageIDs.isEmpty {
            try fileManager.createDirectory(at: imagesDirectory, withIntermediateDirectories: true, attributes: nil)
            for imageID in allImageIDs {
                if let imageURL = ImageStore.shared.urlForImage(with: imageID) {
                    let destinationURL = imagesDirectory.appendingPathComponent("\(imageID).jpg")
                    try fileManager.copyItem(at: imageURL, to: destinationURL)
                }
            }
        }

        let formatter = DateFormatter()
        formatter.dateFormat = "yyyy-MM-dd_HH-mm-ss"
        let zipFileName = "商家记账本备份_\(formatter.string(from: Date())).zip"
        let zipFileURL = fileManager.temporaryDirectory.appendingPathComponent(zipFileName)
        
        if fileManager.fileExists(atPath: zipFileURL.path) {
            try fileManager.removeItem(at: zipFileURL)
        }

        try fileManager.zipItem(at: tempDirectory, to: zipFileURL)
        try fileManager.removeItem(at: tempDirectory)
        
        return zipFileURL
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/FactoryOrderDetailView.swift
// ==========================================

// FactoryOrderDetailView.swift

import SwiftUI
import PhotosUI

struct FactoryOrderDetailView: View {
    @EnvironmentObject var viewModel: OrderViewModel
    let order: Order
    @Binding var item: OrderItem
    
    @State private var textContent: String
    @State private var selectedPhotoItems: [PhotosPickerItem] = []
    
    @State private var imageIdToDelete: String?
    @State private var showingDeleteConfirm = false
    
    @State private var isLoading = false
    @State private var showAlert = false
    @State private var alertTitle = ""
    @State private var alertMessage = ""
    
    @FocusState private var isTextEditorFocused: Bool
    
    init(order: Order, item: Binding<OrderItem>) {
        self.order = order
        self._item = item
        _textContent = State(initialValue: item.wrappedValue.factoryOrderText ?? Self.generateInitialText(for: order, item: item.wrappedValue))
    }

    var body: some View {
        ZStack {
            ScrollView {
                VStack(spacing: 0) {
                    imageStackSection
                    Divider()
                    TextEditor(text: $textContent)
                        .padding()
                        .font(.body)
                        .focused($isTextEditorFocused)
                        .frame(minHeight: 250)
                }
            }
            if isLoading {
                ProgressView("正在生成图片...")
                    .padding(25)
                    .background(.regularMaterial, in: RoundedRectangle(cornerRadius: 15))
                    .shadow(radius: 10)
            }
        }
        .navigationTitle("工厂订单详情")
        .navigationBarTitleDisplayMode(.inline)
        .toolbar {
            ToolbarItem(placement: .navigationBarTrailing) {
                HStack(alignment: .center, spacing: 12) {
                    Button(action: generateAndSaveImage) { Image(systemName: "square.and.arrow.down") }
                    PhotosPicker(selection: $selectedPhotoItems, maxSelectionCount: 10, matching: .images) { Image(systemName: "plus") }
                }
                .font(.headline)
                .foregroundColor(.accentColor)
            }
            ToolbarItemGroup(placement: .keyboard) { Spacer(); Button("完成") { isTextEditorFocused = false } }
        }
        .onChange(of: selectedPhotoItems) { _, newItems in Task { await loadImages(from: newItems) } }
        .alert("确认删除", isPresented: $showingDeleteConfirm, presenting: imageIdToDelete) { id in
            Button("删除", role: .destructive) { deleteImage(imageId: id) }
        } message: { _ in Text("你确定要删除这张图片吗？此操作无法撤销。") }
        .alert(alertTitle, isPresented: $showAlert) {
            Button("好的", role: .cancel) {}
        } message: { Text(alertMessage) }
        .onDisappear(perform: saveChanges)
    }
    
    @ViewBuilder
    private var imageStackSection: some View {
        VStack(spacing: 4) {
            if item.productImageIdentifiers.isEmpty {
                ZStack {
                    Rectangle().fill(Color(.systemGray6)).frame(height: 200)
                    Text("暂无图片，请点击右上角添加").foregroundColor(.secondary)
                }
            } else {
                ForEach(item.productImageIdentifiers, id: \.self) { imageId in
                    if let uiImage = ImageStore.shared.loadImage(withIdentifier: imageId) {
                        Image(uiImage: uiImage).resizable().scaledToFit()
                            .contextMenu {
                                Button(role: .destructive) {
                                    self.imageIdToDelete = imageId
                                    self.showingDeleteConfirm = true
                                } label: { Label("删除图片", systemImage: "trash") }
                            }
                    }
                }
            }
        }
    }
    
    private func generateAndSaveImage() {
        saveChanges()
        isLoading = true
        DispatchQueue.global(qos: .userInitiated).async {
            let imagesToProcess = self.item.productImageIdentifiers.compactMap { ImageStore.shared.loadImage(withIdentifier: $0) }
            let textToProcess = self.textContent
            
            guard let finalImage = OrderImageGenerator.shared.generate(for: self.order, productImages: imagesToProcess, textContent: textToProcess) else {
                DispatchQueue.main.async {
                    self.isLoading = false; self.alertTitle = "生成失败"; self.alertMessage = "无法创建订单图片。"; self.showAlert = true
                }
                return
            }
            ImageStore.shared.saveToPhotoLibrary(finalImage) { success, error in
                DispatchQueue.main.async {
                    self.isLoading = false
                    if success { self.alertTitle = "保存成功"; self.alertMessage = "订单图片已保存到您的相册。" }
                    else { self.alertTitle = "保存失败"; self.alertMessage = "无法保存图片，请检查App的相册访问权限。" }
                    self.showAlert = true
                }
            }
        }
    }

    private func saveChanges() {
        if item.factoryOrderText != textContent {
            item.factoryOrderText = textContent
            viewModel.updateOrder(order)
        }
    }
    
    private func deleteImage(imageId: String) {
        if let index = item.productImageIdentifiers.firstIndex(of: imageId) {
            item.productImageIdentifiers.remove(at: index)
            ImageStore.shared.deleteImage(withIdentifier: imageId)
        }
    }

    private func loadImages(from items: [PhotosPickerItem]) async {
        for item in items {
            if let data = try? await item.loadTransferable(type: Data.self), let uiImage = UIImage(data: data), let newId = ImageStore.shared.saveImage(uiImage) {
                await MainActor.run {
                    self.item.productImageIdentifiers.append(newId)
                }
            }
        }
        await MainActor.run {
            selectedPhotoItems.removeAll()
        }
    }

    // <--- 核心修改点
    static func generateInitialText(for order: Order, item: OrderItem) -> String {
        var lines: [String] = [
            "订单编号: \(order.orderNumber)",
            "客户名称: \(order.customerName)"
        ]
        
        if order.trademark == .guestLabel {
            lines.append("客人标")
        }
        
        lines.append(contentsOf: [
            "产品编号: \(item.productName)",
            "颜色: \(item.color)",
            "码数+数量: \(item.sizeQuantities.sorted { $0.key < $1.key }.map { "\($0.key.replacingOccurrences(of: "码", with: ""))x\($0.value)" }.joined(separator: ", "))"
        ])
        
        if order.urgency == .urgent {
            lines.append("订单加急！")
        }
        
        lines.append("\n\(order.date.formattedAsYMD())")
        
        return lines.joined(separator: "\n")
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/OrderApp.swift
// ==========================================

// OrderApp.swift

import SwiftUI

@main
struct OrderApp: App {
    @UIApplicationDelegateAdaptor(AppDelegate.self) var appDelegate

    @StateObject private var viewModel = OrderViewModel()
    // <<< 修改点 1：创建 UserSettings 的 StateObject 实例 >>>
    @StateObject private var userSettings = UserSettings()

    var body: some Scene {
        WindowGroup {
            ContentView()
                .environmentObject(viewModel)
                // <<< 修改点 2：将 userSettings 注入到环境中 >>>
                .environmentObject(userSettings)
        }
    }
}



// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/EditReworkItemView.swift
// ==========================================

// EditReworkItemView.swift

import SwiftUI
import PhotosUI

struct EditReworkItemView: View {
    @Environment(\.presentationMode) var presentationMode
    
    // 核心修改 1: 从 @Binding 改为 @State。
    // 这意味着此视图现在自己管理“返工项”的数据，而不是依赖外部。
    @State private var reworkItem: ReworkItem
    
    // 核心修改 2: 统一的回调闭包。
    // 无论是创建还是编辑，保存时都会调用这个闭包。
    var onSave: (ReworkItem) -> Void

    // 本地状态（保持不变）
    @State private var newlyLoadedImages: [IdentifiableUIImage] = []
    @State private var selectedPhotoItems: [PhotosPickerItem] = []
    @State private var imageToPreview: UIImage?
    @State private var isPreviewingImage = false

    @FocusState private var focusedField: FocusableField?
    enum FocusableField: Hashable {
        case productName, color, leather, otherReason, quantity(String)
    }
    
    private let allSizes = (33...42).map { "\($0)码" }
    private let columns = [GridItem(.adaptive(minimum: 70))]
    private let imageGridColumns = [GridItem(.adaptive(minimum: 100))]

    private var isFormValid: Bool {
        !reworkItem.reasons.isEmpty &&
        (!reworkItem.reasons.contains(.other) || (reworkItem.reasons.contains(.other) && !(reworkItem.otherReasonDetail?.isEmpty ?? true))) &&
        !reworkItem.reworkedItem.productName.isEmpty &&
        !reworkItem.reworkedItem.sizeQuantities.filter({ $0.value > 0 }).isEmpty
    }
    
    // MARK: - Initializers
    
    // 核心修改 3: 新的、用于“创建”的初始化方法
    init(originalItem: OrderItem, onSave: @escaping (ReworkItem) -> Void) {
        let newItem = ReworkItem(date: .now, originalOrderItemID: originalItem.id, reasons: [], otherReasonDetail: nil, reworkedItem: originalItem)
        // 初始化内部的 @State 变量
        _reworkItem = State(initialValue: newItem)
        self.onSave = onSave
    }
    
    // 核心修改 4: 新的、用于“编辑”的初始化方法
    init(reworkItemToEdit: ReworkItem, onSave: @escaping (ReworkItem) -> Void) {
        // 初始化内部的 @State 变量
        _reworkItem = State(initialValue: reworkItemToEdit)
        self.onSave = onSave
    }

    // MARK: - Body
    // Body部分的代码不需要改变，因为它现在会绑定到内部的 @State reworkItem
    var body: some View {
        NavigationView {
            Form {
                reworkInfoSection
                reworkReasonSection
                productSpecSection
                sizeSelectionSection
                if !reworkItem.reworkedItem.sizeQuantities.filter({$0.value > 0}).isEmpty {
                    sizeQuantitySection
                }
                imageManagementSection
            }
            .navigationTitle("编辑重做订单")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar { mainToolbar }
        }
        .onChange(of: selectedPhotoItems) { _, newItems in Task { await loadNewImages(from: newItems) } }
        .sheet(isPresented: $isPreviewingImage) {
            if let image = imageToPreview { FullScreenImageViewer(image: image) {} }
        }
    }
    
    // MARK: - 辅助视图 (无需修改)
    
    private var reworkInfoSection: some View {
        Section(header: Text("重做信息").font(.headline)) {
            DatePicker("重做日期", selection: $reworkItem.date, displayedComponents: .date)
        }
    }
    
    private var reworkReasonSection: some View {
        Section(header: Text("重做原因*").font(.headline)) {
            ForEach(ReworkReason.allCases) { reason in
                Button(action: { toggleReasonSelection(reason) }) {
                    HStack {
                        Text(reason.displayTitle).foregroundColor(.primary)
                        Spacer()
                        if reworkItem.reasons.contains(reason) {
                            Image(systemName: "checkmark.circle.fill").foregroundColor(.accentColor)
                        } else {
                            Image(systemName: "circle").foregroundColor(.secondary)
                        }
                    }
                }
                .buttonStyle(.plain)
            }
            if reworkItem.reasons.contains(.other) {
                TextField("请填写其他原因", text: $reworkItem.otherReasonDetail.toNonOptional())
                    .focused($focusedField, equals: .otherReason)
            }
        }
    }
    
    private var productSpecSection: some View {
        Section(header: Text("商品规格*").font(.headline)) {
            TextField("商品名称", text: $reworkItem.reworkedItem.productName).focused($focusedField, equals: .productName)
            TextField("颜色", text: $reworkItem.reworkedItem.color).focused($focusedField, equals: .color)
            TextField("皮料", text: $reworkItem.reworkedItem.leather).focused($focusedField, equals: .leather)
        }
    }
    
    private var sizeSelectionSection: some View {
        Section(header: Text("选择尺码*").font(.headline)) {
            LazyVGrid(columns: columns, spacing: 15) {
                ForEach(allSizes, id: \.self) { size in
                    Button(action: { toggleSizeSelection(size) }) {
                        Text(size).font(.headline)
                            .frame(minWidth: 0, maxWidth: .infinity, minHeight: 50)
                            .background(reworkItem.reworkedItem.sizeQuantities[size, default: 0] > 0 ? Color.accentColor : Color.gray.opacity(0.2))
                            .foregroundColor(reworkItem.reworkedItem.sizeQuantities[size, default: 0] > 0 ? .white : .primary)
                            .cornerRadius(8)
                    }
                }
            }.buttonStyle(.plain)
        }
    }
    
    private var sizeQuantitySection: some View {
        Section(header: Text("已选尺码和数量").font(.headline)) {
            ForEach(reworkItem.reworkedItem.sizeQuantities.keys.sorted(), id: \.self) { size in
                 HStack {
                    Text("\(size) 数量:")
                    TextField("", text: quantityBinding(for: size))
                        .keyboardType(.numberPad).focused($focusedField, equals: .quantity(size))
                        .frame(width: 50).foregroundColor(.accentColor).fontWeight(.medium)
                    Spacer()
                    Stepper("", value: stepperBinding(for: size), in: 0...999)
                }
            }
        }
    }
    
    private var imageManagementSection: some View {
        Section(header: imageSectionHeader()) {
            if reworkItem.reworkedItem.productImageIdentifiers.isEmpty && newlyLoadedImages.isEmpty {
                 imagePlaceholderView()
            } else {
                LazyVGrid(columns: imageGridColumns, spacing: 10) {
                    ForEach(reworkItem.reworkedItem.productImageIdentifiers, id: \.self) { identifier in
                        if let uiImage = ImageStore.shared.loadImage(withIdentifier: identifier) {
                            imageThumbnailView(displayImage: uiImage, onTapAction: { showPreview(for: uiImage) }, onDeleteAction: { deleteExistingImage(identifier: identifier) })
                        }
                    }
                    ForEach(newlyLoadedImages) { wrappedImage in
                        imageThumbnailView(displayImage: wrappedImage.image, onTapAction: { showPreview(for: wrappedImage.image) }, onDeleteAction: { newlyLoadedImages.removeAll(where: { $0.id == wrappedImage.id }) })
                    }
                }
                .padding(.vertical, 5)
            }
        }
    }
    
    @ToolbarContentBuilder
    private var mainToolbar: some ToolbarContent {
        ToolbarItem(placement: .navigationBarLeading) { Button("取消") { presentationMode.wrappedValue.dismiss() } }
        ToolbarItem(placement: .navigationBarTrailing) {
            Button("保存") { saveReworkItem() }.disabled(!isFormValid)
        }
        ToolbarItemGroup(placement: .keyboard) {
            Spacer()
            Button("完成") { focusedField = nil }
        }
    }
    
    private func imageSectionHeader() -> some View {
        HStack {
            Text("商品图片").font(.headline)
            Spacer()
            PhotosPicker(selection: $selectedPhotoItems, maxSelectionCount: 10, matching: .images) {
                Label("添加图片", systemImage: "plus.circle.fill")
            }.buttonStyle(.borderless)
        }
    }
    
    @ViewBuilder private func imagePlaceholderView() -> some View {
        PhotosPicker(selection: $selectedPhotoItems, maxSelectionCount: 10, matching: .images) {
            VStack(spacing: 12) {
                Image(systemName: "photo.on.rectangle.angled").font(.system(size: 50))
                Text("添加商品图片").font(.headline)
            }
            .foregroundColor(.secondary).frame(maxWidth: .infinity).frame(height: 150)
            .contentShape(Rectangle())
            .background(
                RoundedRectangle(cornerRadius: 12).stroke(style: StrokeStyle(lineWidth: 2, dash: [8])).foregroundColor(Color.gray.opacity(0.5))
            )
        }.buttonStyle(.plain)
    }
    
    @ViewBuilder private func imageThumbnailView(displayImage: UIImage, onTapAction: @escaping () -> Void, onDeleteAction: @escaping () -> Void) -> some View {
        ZStack(alignment: .topTrailing) {
            Image(uiImage: displayImage)
                .resizable().scaledToFill().frame(width: 100, height: 100).cornerRadius(8)
                .onTapGesture(perform: onTapAction).shadow(color: .black.opacity(0.2), radius: 2, y: 1)
            Button(action: onDeleteAction) {
                Image(systemName: "xmark.circle.fill").font(.title2).symbolRenderingMode(.palette)
                    .foregroundStyle(.white, .red).shadow(color: .black.opacity(0.3), radius: 2, y: 1)
            }.buttonStyle(.plain).offset(x: 8, y: -8)
        }.frame(width: 100, height: 100)
    }
    
    // MARK: - Logic Functions
    
    private func saveReworkItem() {
        let newIdentifiers = newlyLoadedImages.compactMap { ImageStore.shared.saveImage($0.image) }
        reworkItem.reworkedItem.productImageIdentifiers.append(contentsOf: newIdentifiers)
        
        if !reworkItem.reasons.contains(.other) {
            reworkItem.otherReasonDetail = nil
        }
        
        // 核心修改 5: 无论创建还是编辑，都调用统一的 onSave 闭包
        onSave(reworkItem)
        
        presentationMode.wrappedValue.dismiss()
    }
    
    private func toggleReasonSelection(_ reason: ReworkReason) {
        if reworkItem.reasons.contains(reason) {
            reworkItem.reasons.remove(reason)
        } else {
            reworkItem.reasons.insert(reason)
        }
    }
    
    private func toggleSizeSelection(_ size: String) {
        if reworkItem.reworkedItem.sizeQuantities[size] != nil {
            reworkItem.reworkedItem.sizeQuantities[size] = nil
        } else {
            reworkItem.reworkedItem.sizeQuantities[size] = 1
        }
    }
    
    private func quantityBinding(for size: String) -> Binding<String> {
        Binding<String>(
            get: {
                let quantity = self.reworkItem.reworkedItem.sizeQuantities[size, default: 0]
                return quantity > 0 ? String(quantity) : ""
            },
            set: { newStringValue in
                if newStringValue.isEmpty { self.reworkItem.reworkedItem.sizeQuantities[size] = 0 }
                else if let newIntValue = Int(newStringValue) { self.reworkItem.reworkedItem.sizeQuantities[size] = newIntValue }
            }
        )
    }
    
    private func stepperBinding(for size: String) -> Binding<Int> {
        Binding<Int>(
            get: { self.reworkItem.reworkedItem.sizeQuantities[size, default: 0] },
            set: { newValue in
                if newValue <= 0 { self.reworkItem.reworkedItem.sizeQuantities[size] = nil }
                else { self.reworkItem.reworkedItem.sizeQuantities[size] = newValue }
            }
        )
    }
    
    private func loadNewImages(from items: [PhotosPickerItem]) async {
        var loaded: [IdentifiableUIImage] = []
        for item in items {
            if let data = try? await item.loadTransferable(type: Data.self), let uiImage = UIImage(data: data) {
                loaded.append(IdentifiableUIImage(image: uiImage))
            }
        }
        await MainActor.run {
            self.newlyLoadedImages.append(contentsOf: loaded)
            self.selectedPhotoItems.removeAll()
        }
    }
    
    private func deleteExistingImage(identifier: String) {
        reworkItem.reworkedItem.productImageIdentifiers.removeAll { $0 == identifier }
    }
    
    private func showPreview(for image: UIImage) {
        self.imageToPreview = image
        self.isPreviewingImage = true
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/FlatOrderRecord.swift
// ==========================================

// FlatOrderRecord.swift

import Foundation

// 代表扁平化数据库中的单条记录
struct FlatOrderRecord: Identifiable {
    let id = UUID()
    
    // 订单信息
    let orderNumber: String
    let orderDate: Date
    let customerName: String
    let customerType: String
    
    // <<< 核心修复点 1: 用 orderUrgency 替换 orderNotes >>>
    let orderUrgency: String
    
    // 商品信息
    let productName: String
    let color: String
    let leather: String
    
    // 尺码和数量信息
    let size: String
    let quantity: Int
    
    // 价格信息
    let unitPrice: Double
    var itemTotalPrice: Double {
        return Double(quantity) * unitPrice
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/NewOrderViewModel.swift
// ==========================================

// NewOrderViewModel.swift

import SwiftUI

@MainActor
class NewOrderViewModel: ObservableObject {
    @Published var customerName: String = ""
    @Published var customerType: CustomerType = .retail
    @Published var urgency: OrderUrgency = .normal
    @Published var trademark: TrademarkOption = .none
    @Published var shipmentStatus: ShipmentStatus = .notShipped // <--- 修改点
    @Published var orderItems: [OrderItem] = []
    
    // 用于驱动 AddOrderItemView Sheet 的状态
    @Published var itemSheetIsPresented = false
    @Published var itemForEditing = OrderItem()

    // 按钮激活逻辑
    var isSaveEnabled: Bool {
        !customerName.trimmingCharacters(in: .whitespaces).isEmpty && !orderItems.isEmpty
    }
    
    var isFactoryOrderEnabled: Bool {
        guard isSaveEnabled else { return false } // 必须满足保存条件
        // 检查所有商品项的核心信息是否完整
        return !orderItems.contains {
            $0.productName.isEmpty || $0.color.isEmpty || $0.leather.isEmpty || $0.sizeQuantities.isEmpty
        }
    }
    
    var totalQuantity: Int {
        orderItems.reduce(0) { $0 + $1.totalItemQuantity }
    }
    
    var totalPrice: Double {
        orderItems.reduce(0) { $0 + $1.totalItemPrice }
    }
    
    var hasPendingPrice: Bool {
        orderItems.contains { $0.unitPrice <= 0 }
    }

    // 准备添加新商品
    func prepareNewItem() {
        itemForEditing = OrderItem() // 创建一个全新的空 item
        itemSheetIsPresented = true
    }
    
    // 准备编辑现有商品
    func prepareToEdit(_ item: OrderItem) {
        itemForEditing = item // 将要编辑的 item 赋值
        itemSheetIsPresented = true
    }
    
    // 从 AddOrderItemView 保存返回的商品
    func saveItem(_ item: OrderItem) {
        if let index = orderItems.firstIndex(where: { $0.id == item.id }) {
            // 如果是编辑，替换数组中的旧项
            orderItems[index] = item
        } else {
            // 如果是新增，追加到数组末尾
            orderItems.append(item)
        }
    }
    
    // 删除商品项
    func deleteItem(at offsets: IndexSet) {
        let itemsToDelete = offsets.map { orderItems[$0] }
        // 删除关联的图片
        for item in itemsToDelete {
            ImageStore.shared.deleteImages(withIdentifiers: item.productImageIdentifiers)
        }
        orderItems.remove(atOffsets: offsets)
    }

    // 用户点击最终的“保存”按钮时调用
    func saveOrder(in mainViewModel: OrderViewModel) -> Order {
        let finalOrder = Order(
            orderNumber: "", // OrderViewModel会生成
            customerName: customerName,
            date: Date(),
            orderItems: orderItems,
            urgency: urgency,
            customerType: customerType,
            trademark: trademark,
            shipmentStatus: shipmentStatus // <--- 修改点
        )
        return mainViewModel.addOrder(finalOrder)
    }
    
    // 当用户点击“取消”时，清理所有已上传但未保存的图片
    func cleanupImagesOnCancel() {
        for item in orderItems {
            ImageStore.shared.deleteImages(withIdentifiers: item.productImageIdentifiers)
        }
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/ViewStyles.swift
// ==========================================


//ViewStyles.swift

import SwiftUI

// 将按钮样式定义在自己的文件中，以便整个 App 都可以访问
struct FactoryOrderButtonStyle: ButtonStyle {
    @Environment(\.isEnabled) private var isEnabled

    func makeBody(configuration: Configuration) -> some View {
        configuration.label
            .padding(.vertical, 12)
            .foregroundColor(.white)
            .background(isEnabled ? Color.accentColor : Color.gray) // 可用时为蓝色，禁用时为灰色
            .cornerRadius(10)
            .opacity(configuration.isPressed ? 0.8 : 1.0)
            .scaleEffect(configuration.isPressed ? 0.98 : 1.0)
    }
}


// <<< 核心修复点 1: 在这里定义全局可用的 statusTag 函数 >>>
@ViewBuilder
func statusTag(text: String, color: Color, backgroundColor: Color) -> some View {
    Text(text)
        .font(.system(size: 9, weight: .bold))
        .foregroundColor(color)
        .padding(.horizontal, 6)
        .padding(.vertical, 3)
        .background(backgroundColor, in: Capsule())
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/RefundedOrdersView.swift
// ==========================================

// RefundedOrdersView.swift
// 已修复编译器无法在合理时间内完成类型检查的错误

import SwiftUI

struct RefundedOrdersView: View {
    @EnvironmentObject var viewModel: OrderViewModel
    @EnvironmentObject var userSettings: UserSettings // <<< 修复点1: 添加 UserSettings 环璄变量 >>>
    @Environment(\.presentationMode) var presentationMode
    
    @Namespace private var refundedNamespace
    
    @State private var searchText = ""
    @State private var selectedOrder: Order?

    private var refundedOrders: [Order] {
        viewModel.orders.filter { $0.status == .refunded }
    }
    
    private var filteredOrders: [Order] {
        if searchText.isEmpty {
            return refundedOrders
        } else {
            return refundedOrders.filter {
                $0.customerName.localizedCaseInsensitiveContains(searchText) ||
                $0.orderNumber.localizedCaseInsensitiveContains(searchText)
            }
        }
    }
    
    // MARK: - Body
    var body: some View {
        // <<< 修复点2: 将 GeometryReader 移到最外层 >>>
        // 这样可以确保 screenWidth 在所有子视图中都可用
        GeometryReader { geometry in
            NavigationView {
                // 将主要内容提取到一个私有函数中，以简化 body
                mainContent(screenWidth: geometry.size.width)
                    .background(Color(.systemGroupedBackground))
                    .navigationTitle("退货退款记录")
                    .navigationBarTitleDisplayMode(.inline)
                    .searchable(text: $searchText, prompt: "搜索客户或订单号")
                    .toolbar {
                        ToolbarItem(placement: .navigationBarTrailing) {
                            Button("完成") { presentationMode.wrappedValue.dismiss() }
                        }
                    }
                    .sheet(item: $selectedOrder) { orderToEdit in
                        if let index = viewModel.orders.firstIndex(where: { $0.id == orderToEdit.id }) {
                            NavigationView {
                                OrderDetailView(order: $viewModel.orders[index])
                            }
                            .environmentObject(viewModel)
                            .environmentObject(userSettings) // 确保 sheet 也能获取到
                        }
                    }
            }
        }
    }
    
    // MARK: - 辅助视图构建器
    
    // <<< 修复点3: 将主要内容封装成一个私有函数 >>>
    @ViewBuilder
    private func mainContent(screenWidth: CGFloat) -> some View {
        VStack(spacing: 0) {
            summaryCard
                .padding([.horizontal, .top])
            
            if filteredOrders.isEmpty {
                emptyStateView
            } else {
                orderListView(screenWidth: screenWidth)
            }
        }
    }

    // <<< 修复点4: 将 List 及其内容也封装成一个私有函数 >>>
    @ViewBuilder
    private func orderListView(screenWidth: CGFloat) -> some View {
        List {
            ForEach(filteredOrders) { order in
                ZStack(alignment: .topTrailing) {
                    OrderRowView(
                        order: order,
                        screenWidth: screenWidth,
                        // <<< 修复点1: 传递 fontScaleMultiplier >>>
                        fontScaleMultiplier: userSettings.fontScaleMultiplier,
                        onImageTapped: { _ in },
                        namespace: refundedNamespace
                    )
                    .saturation(0)
                    
                    statusTag(text: "退货退款", color: .white, backgroundColor: .gray)
                        .padding([.top, .trailing], 6)
                }
                .padding(.horizontal)
                .onTapGesture {
                    self.selectedOrder = order
                }
                .listRowInsets(EdgeInsets(top: 5, leading: 0, bottom: 5, trailing: 0))
                .listRowSeparator(.hidden)
            }
        }
        .listStyle(.plain)
    }

    @ViewBuilder
    private var summaryCard: some View {
        let totalRefundAmount = refundedOrders.reduce(0) { $0 + $1.totalOrderPrice }
        let totalRefundUnits = refundedOrders.reduce(0) { $0 + $1.totalOrderQuantity }
        
        VStack(alignment: .leading, spacing: 15) {
            HStack {
                Image(systemName: "arrow.uturn.backward.circle.fill")
                    .font(.title2)
                    .foregroundColor(.gray)
                Text("已退款总额")
                    .font(.headline)
                Spacer()
                Text("¥\(String(format: "%.2f", totalRefundAmount))")
                    .font(.system(.title, design: .rounded).bold())
                    .foregroundColor(.gray)
            }
            Divider()
            HStack {
                RefundStatItem(title: "退款单数", value: "\(refundedOrders.count) 单")
                Spacer()
                RefundStatItem(title: "退款件数", value: "\(totalRefundUnits) 件")
                Spacer()
            }
        }
        .padding()
        .background(Color(.systemBackground))
        .cornerRadius(12)
        .shadow(color: .black.opacity(0.05), radius: 5, y: 2)
    }

    @ViewBuilder
    private var emptyStateView: some View {
        VStack(spacing: 20) {
            Spacer()
            Image(systemName: "tray.fill")
                .font(.system(size: 70))
                .foregroundColor(.secondary)
            Text("暂无退款记录")
                .font(.title.bold())
            Text("所有退货退款的订单会在这里显示")
                .font(.body)
                .foregroundColor(.secondary)
            Spacer()
            Spacer()
        }
        .frame(maxWidth: .infinity)
    }
}

private struct RefundStatItem: View {
    let title: String
    let value: String
    
    var body: some View {
        VStack(alignment: .leading, spacing: 4) {
            Text(title)
                .font(.caption)
                .foregroundColor(.secondary)
            Text(value)
                .font(.callout.weight(.medium))
        }
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/Extensions.swift
// ==========================================

// Extensions.swift

import SwiftUI

// 这个文件专门存放所有通用的 SwiftUI 扩展

// MARK: - Binding<String?>
extension Binding where Value == String? {
    /// 将一个可选的 String 绑定转换为非可选的 String 绑定。
    ///
    /// 这对于需要 String 绑定的 TextField 视图非常有用。
    /// 当 TextField 为空时，绑定的原始值会变为 nil。
    func toNonOptional() -> Binding<String> {
        return Binding<String>(
            get: { self.wrappedValue ?? "" },
            set: { self.wrappedValue = $0.isEmpty ? nil : $0 }
        )
    }
}

// MARK: - Binding<String>
extension Binding where Value == String {
    /// 将一个非可选的 String 绑定转换为可选的 String 绑定。
    ///
    /// 这在需要将一个非可选的状态变量与一个期望可选绑定的视图组件连接时很有用。
    func toOptional() -> Binding<String?> {
        return Binding<String?>(
            get: { self.wrappedValue },
            set: { self.wrappedValue = $0 ?? "" }
        )
    }
}

// MARK: - Binding<ProductType?>
extension Binding {
    /// 通用扩展，将任何可选类型的绑定转换为一个有默认值的非可选绑定。
    ///
    /// 示例: `productType.toUnwrapped(defaultValue: .custom)`
    func toUnwrapped<T>(defaultValue: T) -> Binding<T> where Value == T? {
        Binding<T>(
            get: { self.wrappedValue ?? defaultValue },
            set: { self.wrappedValue = $0 }
        )
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/OrderDetailView.swift
// ==========================================

// OrderDetailView.swift

import SwiftUI
import PhotosUI

struct OrderDetailView: View {
    @EnvironmentObject var viewModel: OrderViewModel
    @EnvironmentObject var userSettings: UserSettings
    @Binding var order: Order
    @Environment(\.presentationMode) var presentationMode
    
    // --- 状态管理 ---
    @State private var showingAddOrEditItemSheet = false
    @State private var itemForEditing: OrderItem = OrderItem()

    @State private var showingAddPaymentSheet = false
    @State private var itemToRework: OrderItem? = nil
    @State private var reworkItemToEditID: OrderIDWrapper? = nil

    @FocusState private var focusedField: FocusField?
    enum FocusField { case customerName }
    
    private var isReadOnly: Bool {
        order.status == .refunded
    }

    var body: some View {
        Form {
            if isReadOnly {
                readOnlyBanner
            }
            
            customerInfoSection
            orderItemsSection
            
            if !order.reworkItems.isEmpty {
                reworkItemsSection
            }
            
            paymentStatusSection
            orderTotalSection
            logisticsSection
            
            factoryOrderButtonSection
        }
        .navigationTitle(isReadOnly ? "订单明细 (已退款)" : "订单明细/编辑")
        .navigationBarTitleDisplayMode(.inline)
        .toolbar {
            if !isReadOnly {
                ToolbarItem(placement: .navigationBarTrailing) { Button("完成") { presentationMode.wrappedValue.dismiss() } }
            }
            ToolbarItemGroup(placement: .keyboard) { Spacer(); Button("完成") { focusedField = nil } }
        }
        .sheet(isPresented: $showingAddOrEditItemSheet) {
            AddOrderItemView(item: $itemForEditing) { savedItem in
                handleItemSave(savedItem)
            }
        }
        .sheet(isPresented: $showingAddPaymentSheet) {
            AddPaymentSheet(order: $order) { showingAddPaymentSheet = false }
        }
        .sheet(item: $itemToRework) { item in
            EditReworkItemView(originalItem: item) { finalRework in
                order.reworkItems.append(finalRework)
            }
        }
        .sheet(item: $reworkItemToEditID) { wrapper in
            if let index = order.reworkItems.firstIndex(where: { $0.id == wrapper.id }) {
                EditReworkItemView(reworkItemToEdit: order.reworkItems[index]) { finalRework in
                    order.reworkItems[index] = finalRework
                }
            }
        }
    }
    
    // MARK: - Sections
    
    private var readOnlyBanner: some View {
        Section {
            HStack(spacing: 10) {
                Image(systemName: "arrow.uturn.backward.circle.fill")
                Text("此订单已退货退款")
                Spacer()
                Button("恢复订单") {
                    viewModel.updateOrderStatus(for: order.id, to: .active)
                }
                .buttonStyle(.bordered)
            }
            .font(.headline).foregroundColor(.secondary).frame(maxWidth: .infinity, alignment: .center)
        }
    }
    
    private var customerInfoSection: some View {
        Section(header: Text("订单信息").font(.headline)) {
            HStack { Text("订单编号:"); Spacer(); Text(order.orderNumber).foregroundColor(.secondary) }
            TextField("客户名称", text: $order.customerName).focused($focusedField, equals: .customerName)
            Picker("客户类型", selection: $order.customerType) {
                ForEach(CustomerType.allCases) { Text($0.displayTitle).tag($0) }
            }.pickerStyle(.segmented)
            Picker("订单类型", selection: $order.urgency) {
                ForEach(OrderUrgency.allCases) { Text($0.displayTitle).tag($0) }
            }.pickerStyle(.segmented)
            Picker("商标", selection: $order.trademark) {
                ForEach(TrademarkOption.allCases) { Text($0.displayTitle).tag($0) }
            }.pickerStyle(.segmented)
            DatePicker("订单日期:", selection: $order.date, displayedComponents: .date)
        }
        .disabled(isReadOnly)
    }
    
    private var orderItemsSection: some View {
        Section(header: sectionHeaderWithAddItemButton) {
            if order.orderItems.isEmpty { Text("此订单没有商品项。").foregroundColor(.gray) }
            else {
                ForEach(order.orderItems) { item in
                    OrderItemDetailRow(item: item, onEdit: { edit(item: item) })
                        .contextMenu {
                            if !isReadOnly {
                                Button { itemToRework = item } label: { Label("重做订单", systemImage: "arrow.2.circlepath") }
                            }
                        }
                }
                .onDelete(perform: deleteOrderItem)
            }
        }
        .deleteDisabled(isReadOnly)
    }

    private var reworkItemsSection: some View {
        Section(header: Text("重做商品列表").font(.headline)) {
            ForEach($order.reworkItems) { $reworkItem in
                reworkRow(for: $reworkItem)
            }
            .onDelete(perform: deleteReworkItem)
        }
        .deleteDisabled(isReadOnly)
    }
    
    private var paymentStatusSection: some View {
        Section {
            VStack(spacing: 10) {
                HStack {
                    Text("付款状态:")
                    Spacer()
                    Text(order.paymentStatus.rawValue).fontWeight(.bold).foregroundColor(order.paymentStatus.color)
                }
                if order.paymentStatus != .paid && order.paymentStatus != .pendingPrice && !isReadOnly {
                    Button(action: { showingAddPaymentSheet = true }) {
                        HStack { Spacer(); Image(systemName: "plus.circle.fill"); Text("记录一笔收款").fontWeight(.semibold); Spacer() }
                    }
                    .buttonStyle(FactoryOrderButtonStyle())
                }
            }
            .padding(.vertical, 5)
        }
    }
    
    private var orderTotalSection: some View {
        Section(header: Text("订单总计").font(.headline)) {
            HStack { Text("总数量:"); Spacer(); Text("\(order.totalOrderQuantity) 件") }
            HStack {
                Text(order.hasPendingPrice ? "总金额 (单价待定):" : "总金额:")
                Spacer()
                Text("¥\(String(format: "%.2f", order.totalOrderPrice))")
                    .font(.title3.weight(.semibold))
                    .foregroundColor(order.hasPendingPrice ? .red : .blue)
            }
            if !order.hasPendingPrice && order.paymentStatus != .unpaid {
                HStack { Text("已收金额:"); Spacer(); Text("¥\(order.paidAmount, specifier: "%.2f")").foregroundColor(order.paymentStatus.color) }
                HStack { Text("剩余未付:").fontWeight(.bold); Spacer(); Text("¥\(order.balanceDue, specifier: "%.2f")").fontWeight(.bold).foregroundColor(order.balanceDue > 0 ? .orange : .green) }
            }
            if !order.payments.isEmpty {
                DisclosureGroup("查看收款记录 (\(order.payments.count))") {
                    ForEach(order.payments) { payment in
                        VStack(alignment: .leading, spacing: 4) {
                            Text("¥\(payment.amount, specifier: "%.2f")").fontWeight(.bold)
                            Text("\(payment.date.formattedAsYMD()) - \(payment.method.displayTitle)").font(.caption).foregroundColor(.secondary)
                            if let notes = payment.notes, !notes.isEmpty { Text("备注: \(notes)").font(.caption).foregroundColor(.secondary) }
                        }.padding(.vertical, 4)
                    }
                    .onDelete(perform: deletePayment)
                    .deleteDisabled(isReadOnly)
                }
            }
        }
    }

    private var logisticsSection: some View {
        // <--- 修改点
        Section(header: Text("物流信息")) {
            Picker("发货状态", selection: $order.shipmentStatus) {
                ForEach(ShipmentStatus.allCases) { status in
                    Text(status.displayTitle).tag(status)
                }
            }
            .pickerStyle(.segmented)
        }
        .disabled(isReadOnly)
    }

    private var factoryOrderButtonSection: some View {
        Section(footer: order.customerName.isEmpty ? Text("请先填写客户名称才能生成工厂订单。").foregroundColor(.red).font(.caption) : nil) {
            ZStack {
                NavigationLink(destination: factoryOrderDestinationView(for: order.orderItems)) { EmptyView() }.opacity(0)
                HStack { Spacer(); Image(systemName: "doc.text.fill"); Text("生成工厂订单").fontWeight(.semibold); Spacer() }
            }
            .buttonStyle(FactoryOrderButtonStyle())
            .listRowInsets(EdgeInsets())
        }
        .disabled(order.orderItems.isEmpty || isReadOnly || order.customerName.isEmpty)
    }
    
    // MARK: - Helper Functions & Views
    
    private var sectionHeaderWithAddItemButton: some View {
        HStack {
            Text("商品列表 (\(order.orderItems.count))").font(.headline)
            Spacer()
            if !isReadOnly {
                Button(action: addItem) {
                    Image(systemName: "plus.circle.fill"); Text("添加商品")
                }
                .buttonStyle(.borderless)
            }
        }
    }
    
    private func addItem() {
        itemForEditing = OrderItem()
        showingAddOrEditItemSheet = true
    }
    
    private func edit(item: OrderItem) {
        itemForEditing = item
        showingAddOrEditItemSheet = true
    }
    
    private func handleItemSave(_ savedItem: OrderItem) {
        let priceBefore = order.totalOrderPrice
        
        if let index = order.orderItems.firstIndex(where: { $0.id == savedItem.id }) {
            order.orderItems[index] = savedItem
        } else {
            order.orderItems.append(savedItem)
        }
        
        let priceAfter = order.totalOrderPrice
        if abs(priceAfter - priceBefore) > 0.001 {
            order.payments.removeAll()
        }
    }
    
    private func deleteOrderItem(at offsets: IndexSet) {
        guard !isReadOnly else { return }
        let priceBeforeDelete = order.totalOrderPrice
        let itemsToDelete = offsets.map { order.orderItems[$0] }
        for item in itemsToDelete { ImageStore.shared.deleteImages(withIdentifiers: item.productImageIdentifiers) }
        order.orderItems.remove(atOffsets: offsets)
        let priceAfterDelete = order.totalOrderPrice
        if abs(priceAfterDelete - priceBeforeDelete) > 0.001 { order.payments.removeAll() }
    }
    
    private func deleteReworkItem(at offsets: IndexSet) {
        guard !isReadOnly else { return }
        let itemsToDelete = offsets.map { order.reworkItems[$0] }
        for item in itemsToDelete { ImageStore.shared.deleteImages(withIdentifiers: item.reworkedItem.productImageIdentifiers) }
        order.reworkItems.remove(atOffsets: offsets)
    }
    
    private func deletePayment(at offsets: IndexSet) {
        guard !isReadOnly else { return }
        order.payments.remove(atOffsets: offsets)
    }
    
    @ViewBuilder
    private func reworkRow(for reworkItemBinding: Binding<ReworkItem>) -> some View {
        let reworkItem = reworkItemBinding.wrappedValue
        VStack(spacing: 8) {
            HStack {
                OrderItemRowSummary(item: reworkItem.reworkedItem, showPriceInfo: false, onEdit: { self.reworkItemToEditID = OrderIDWrapper(id: reworkItem.id) })
                    .contentShape(Rectangle())
                    .onTapGesture { self.reworkItemToEditID = OrderIDWrapper(id: reworkItem.id) }
            }
            VStack(alignment: .leading, spacing: 2) {
                Text("重做原因: \(reworkItem.reasons.map { $0.displayTitle }.joined(separator: ", "))")
                if let other = reworkItem.otherReasonDetail, !other.isEmpty { Text("其他原因: \(other)") }
            }.font(.caption).foregroundColor(.secondary).padding(.leading, 92)
            NavigationLink(destination: factoryOrderDestinationView(for: [reworkItem.reworkedItem])) {
                HStack { Spacer(); Image(systemName: "doc.text.fill"); Text("生成重做工厂订单"); Spacer() }
                .font(.footnote.weight(.semibold)).padding(8).background(Color.accentColor.opacity(0.1)).foregroundColor(.accentColor).cornerRadius(8)
            }.padding(.top, 4)
        }.padding(.vertical, 5)
    }
    
    @ViewBuilder
    private func factoryOrderDestinationView(for items: [OrderItem]) -> some View {
        if items.count > 1 {
            FactoryItemSelectionView(order: order)
        } else if let firstItem = items.first {
            if let originalIndex = order.orderItems.firstIndex(where: { $0.id == firstItem.id }) {
                FactoryOrderDetailView(order: order, item: $order.orderItems[originalIndex])
            } else if let reworkIndex = order.reworkItems.firstIndex(where: { $0.reworkedItem.id == firstItem.id }) {
                FactoryOrderDetailView(order: order, item: $order.reworkItems[reworkIndex].reworkedItem)
            } else { Text("无法找到对应的商品项") }
        } else { Text("没有可用的商品项") }
    }
}

// MARK: - 辅助视图定义 (保持不变)
struct OrderItemDetailRow: View {
    let item: OrderItem
    var onEdit: () -> Void
    private let imageSize: CGFloat = 80
    var body: some View {
        HStack(alignment: .top, spacing: 12) {
            if let firstImageId = item.productImageIdentifiers.first,
               let uiImage = ImageStore.shared.loadImage(withIdentifier: firstImageId) {
                Image(uiImage: uiImage).resizable().scaledToFill().frame(width: imageSize, height: imageSize).cornerRadius(8).clipped()
            } else {
                RoundedRectangle(cornerRadius: 8).fill(Color.gray.opacity(0.1)).frame(width: imageSize, height: imageSize).overlay(Image(systemName: "photo").foregroundColor(.gray))
            }
            VStack(alignment: .leading, spacing: 8) {
                HStack {
                    Text(item.productName).font(.title3.weight(.medium))
                    Spacer()
                    Button(action: onEdit) { Image(systemName: "square.and.pencil") }.buttonStyle(.borderless)
                }
                Text("\(item.color) / \(item.leather)").font(.callout).foregroundColor(.secondary)
                Text("单价: ¥\(String(format: "%.2f", item.unitPrice)) x \(item.totalItemQuantity) = ¥\(String(format: "%.2f", item.totalItemPrice))").font(.callout)
                if !item.sizeQuantities.isEmpty { Text("尺码: \(sizeSummary(item.sizeQuantities))").font(.callout).foregroundColor(.secondary) }
            }
        }.padding(.vertical, 5)
    }
    private func sizeSummary(_ quantities: [String: Int]) -> String { quantities.keys.sorted().map { "\($0.replacingOccurrences(of: "码", with: ""))x\(quantities[$0] ?? 0)" }.joined(separator: ", ") }
}

struct AddPaymentSheet: View {
    @Binding var order: Order
    var onConfirm: () -> Void
    @Environment(\.presentationMode) var presentationMode
    @State private var amountString = ""
    @State private var confirmationDate = Date()
    @State private var paymentMethod: PaymentMethod = .bankTransfer
    @State private var notes = ""
    private var amount: Double { Double(amountString) ?? 0 }
    private var isAmountValid: Bool { amount > 0 && amount <= (order.balanceDue + 0.001) }
    var body: some View {
        NavigationView {
            Form {
                Section(header: Text("新收款信息")) {
                    HStack {
                        Text("¥"); TextField("本次收款金额", text: $amountString).keyboardType(.decimalPad)
                        if order.balanceDue > 0 { Button("全额") { amountString = String(format: "%.2f", order.balanceDue) }.buttonStyle(.bordered) }
                    }
                    if !isAmountValid && !amountString.isEmpty { Text("金额无效或已超出剩余未付金额 ¥\(String(format: "%.2f", order.balanceDue))").font(.caption).foregroundColor(.red) }
                    DatePicker("收款日期", selection: $confirmationDate, displayedComponents: .date)
                    Picker("收款方式", selection: $paymentMethod) { ForEach(PaymentMethod.allCases) { Text($0.displayTitle).tag($0) } }
                    VStack(alignment: .leading) {
                        Text("备注 (可选)"); TextEditor(text: $notes).frame(height: 100).overlay(RoundedRectangle(cornerRadius: 5).stroke(Color(.systemGray5), lineWidth: 1).opacity(0.5))
                    }
                }
            }
            .navigationTitle("添加收款记录").navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) { Button("取消") { presentationMode.wrappedValue.dismiss() } }
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("确认添加") {
                        let newPayment = Payment(date: confirmationDate, amount: amount, method: paymentMethod, notes: notes.isEmpty ? nil : notes)
                        order.payments.append(newPayment); onConfirm()
                    }.disabled(!isAmountValid)
                }
            }
        }
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/ShipmentTrackingView.swift
// ==========================================

// ShipmentTrackingView.swift

import SwiftUI
import UIKit

struct ShipmentTrackingView: View {
    @EnvironmentObject var viewModel: OrderViewModel
    @Environment(\.presentationMode) var presentationMode
    
    @State private var reportText: String = "正在生成报告..."
    
    // 定义工厂出货周期为7天
    private let shippingDeadlineInDays: Int = 7

    var body: some View {
        NavigationView {
            VStack(spacing: 0) {
                TextEditor(text: $reportText)
                    .font(.system(.body, design: .monospaced))
                    .padding()
            }
            .navigationTitle("出货追踪报告")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarTrailing) {
                    HStack(spacing: 15) {
                        Button(action: copyReport) {
                            Image(systemName: "doc.on.doc")
                        }
                        Button("关闭") {
                            presentationMode.wrappedValue.dismiss()
                        }
                    }
                }
            }
            .onAppear(perform: generateTrackingReport)
        }
    }
    
    private func copyReport() {
        UIPasteboard.general.string = reportText
    }
    
    // MARK: - 核心修改: 重构报告生成逻辑
    private func generateTrackingReport() {
        let unshippedOrders = viewModel.orders.filter { $0.shipmentStatus == .notShipped }
        
        if unshippedOrders.isEmpty {
            self.reportText = "太棒了！所有订单均已出货。"
            return
        }

        let today = Calendar.current.startOfDay(for: Date())

        let reportItems = unshippedOrders.map { order -> ReportItem in
            let orderDate = Calendar.current.startOfDay(for: order.date)
            let deadlineDate = Calendar.current.date(byAdding: .day, value: shippingDeadlineInDays, to: orderDate)!
            let daysDifference = Calendar.current.dateComponents([.day], from: today, to: deadlineDate).day ?? 0
            return ReportItem(order: order, daysDifference: daysDifference)
        }
        
        // 1. 按“加急”和“正常”进行分组
        let urgentItems = reportItems
            .filter { $0.order.urgency == .urgent }
            .sorted { $0.daysDifference < $1.daysDifference }
        
        let normalItems = reportItems
            .filter { $0.order.urgency == .normal }
            .sorted { $0.daysDifference < $1.daysDifference }

        // 2. 计算顶部的汇总数据
        let totalUnshippedCount = urgentItems.reduce(0) { $0 + $1.order.totalOrderQuantity } + normalItems.reduce(0) { $0 + $1.order.totalOrderQuantity }
        let totalUrgentCount = urgentItems.reduce(0) { $0 + $1.order.totalOrderQuantity }
        let totalNormalCount = normalItems.reduce(0) { $0 + $1.order.totalOrderQuantity }
        
        var reportLines: [String] = []

        // 3. 构建汇总信息部分
        reportLines.append("待出货总数：\(totalUnshippedCount)对")
        reportLines.append("加急出货总数：\(totalUrgentCount)对")
        reportLines.append("正常出货总数：\(totalNormalCount)对")
        reportLines.append("") // 添加一个空行

        // 4. 构建“加急出货”部分
        if !urgentItems.isEmpty {
            reportLines.append("一、加急出货")
            let urgentStrings = urgentItems.enumerated().map { (index, item) -> String in
                return "\(index + 1). \(item.formattedString)"
            }
            reportLines.append(contentsOf: urgentStrings)
            reportLines.append("") // 添加一个空行
        }

        // 5. 构建“正常出货”部分
        if !normalItems.isEmpty {
            reportLines.append("二、正常出货")
            let normalStrings = normalItems.enumerated().map { (index, item) -> String in
                return "\(index + 1). \(item.formattedString)"
            }
            reportLines.append(contentsOf: normalStrings)
        }
        
        // 6. 拼接成最终的报告文本
        self.reportText = reportLines.joined(separator: "\n")
    }
}

// MARK: - 辅助数据结构 (格式化字符串已更新)
private struct ReportItem {
    let order: Order
    let daysDifference: Int

    var deadlineStatus: String {
        if daysDifference < 0 {
            return "逾期 \(-daysDifference) 日"
        } else if daysDifference == 0 {
            return "今日出货！"
        } else {
            return "\(daysDifference) 日内出货"
        }
    }
    
    // MARK: - 修改点: 移除 urgency 状态，因为它已经通过分组体现了
    var formattedString: String {
        "订单: \(order.orderNumber) | \(deadlineStatus) | \(order.totalOrderQuantity)对"
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/OrderRowView.swift
// ==========================================

// OrderRowView.swift
// 已修复编译错误

import SwiftUI

struct OrderRowView: View {
    let order: Order
    let screenWidth: CGFloat
    let fontScaleMultiplier: Double
    var onImageTapped: (Order) -> Void
    var namespace: Namespace.ID
    
    private let imageAreaWidth: CGFloat = 110

    var body: some View {
        HStack(alignment: .top, spacing: 15) {
            VStack(alignment: .leading, spacing: 6) {
                if order.customerName.isEmpty {
                    Text("客户名待填写")
                        .scaledFont(size: FontSizeManager.scaledSize(for: .headline, in: screenWidth, multiplier: fontScaleMultiplier))
                        .fontWeight(.semibold)
                        .lineLimit(2)
                        .foregroundColor(.red)
                } else {
                    Text(order.customerName)
                        .scaledFont(size: FontSizeManager.scaledSize(for: .headline, in: screenWidth, multiplier: fontScaleMultiplier))
                        .fontWeight(.semibold)
                        .lineLimit(2)
                }
                
                productNameListView
                
                HStack(spacing: 8) {
                    HStack(spacing: 4) {
                        Text("总数:")
                        Text("\(order.totalOrderQuantity)件")
                    }
                    
                    if !order.reworkItems.isEmpty {
                        // <<< 核心修复点 2: 现在编译器可以找到 statusTag 了 >>>
                        statusTag(text: "含返工", color: .white, backgroundColor: .purple)
                    }
                }
                .scaledFont(size: FontSizeManager.scaledSize(for: .caption, in: screenWidth, multiplier: fontScaleMultiplier))
                .foregroundColor(.secondary)
                .padding(.top, 2)

                salesAmountView
                
                Spacer(minLength: 0)
                
                Text(order.date.formattedAsYMD())
                    .scaledFont(size: FontSizeManager.scaledSize(for: .caption, in: screenWidth, multiplier: fontScaleMultiplier))
                    .foregroundColor(.gray)
                    .padding(.top, 4)
            }
            .frame(maxWidth: .infinity, alignment: .leading)

            Button(action: { onImageTapped(order) }) {
                imageStackView
            }
            .buttonStyle(.plain)
            .frame(width: imageAreaWidth, height: imageAreaWidth)
        }
        .padding(12)
        .background(Color(.systemBackground))
        .cornerRadius(12)
        .shadow(color: .black.opacity(0.08), radius: 5, y: 3)
    }
    
    @ViewBuilder
    private var salesAmountView: some View {
        HStack(spacing: 4) {
            Text("销售额:")
            
            if order.hasPendingPrice {
                (Text("¥\(String(format: "%.2f", order.totalOrderPrice))") + Text(" (单价待定)"))
                    .foregroundColor(.red)
            } else {
                Text("¥\(String(format: "%.2f", order.totalOrderPrice))")
            }
        }
        .foregroundColor(.secondary)
        .scaledFont(size: FontSizeManager.scaledSize(for: .caption, in: screenWidth, multiplier: fontScaleMultiplier))
        .fontWeight(.medium)
        .lineLimit(1)
        .minimumScaleFactor(0.8)
    }
    
    @ViewBuilder
    private var imageStackView: some View {
        let identifiers = order.previewImageIdentifiers
        
        ZStack {
            if identifiers.isEmpty {
                ZStack {
                    RoundedRectangle(cornerRadius: 8).fill(Color.gray.opacity(0.1))
                    Image(systemName: "photo.on.rectangle.angled").font(.title).foregroundColor(.gray.opacity(0.6))
                }
                .frame(width: imageAreaWidth, height: imageAreaWidth)
            } else {
                ForEach(Array(identifiers.prefix(3).reversed().enumerated()), id: \.element) { (index, imageId) in
                    if let uiImage = ImageStore.shared.loadImage(withIdentifier: imageId) {
                        Image(uiImage: uiImage)
                            .resizable().scaledToFill().frame(width: imageAreaWidth, height: imageAreaWidth)
                            .cornerRadius(8).clipped()
                            .shadow(color: .black.opacity(0.15), radius: 3, y: 2)
                            .offset(x: CGFloat(index) * -5, y: CGFloat(index) * -5)
                            .matchedGeometryEffect(
                                id: (index == (identifiers.prefix(3).count - 1)) ? "image_\(imageId)" : "image_bg_\(imageId)",
                                in: namespace
                            )
                    }
                }
            }
        }
    }

    @ViewBuilder
    private var productNameListView: some View {
        let items = order.orderItems
        if !items.isEmpty {
            VStack(alignment: .leading, spacing: 4) {
                ForEach(Array(items.prefix(3).enumerated()), id: \.element.id) { index, item in
                    if index == 2 && items.count > 3 {
                        (Text(item.productName) + Text(" 等 共计 \(items.count)款").foregroundColor(.gray))
                            .font(.system(size: FontSizeManager.scaledSize(for: .caption, in: screenWidth, multiplier: fontScaleMultiplier)))
                            .foregroundColor(.secondary).lineLimit(1)
                    } else {
                        Text(item.productName)
                            .scaledFont(size: FontSizeManager.scaledSize(for: .caption, in: screenWidth, multiplier: fontScaleMultiplier))
                            .foregroundColor(.secondary).lineLimit(1)
                    }
                }
            }
        }
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/AnalyticsView.swift
// ==========================================

import SwiftUI
import Charts

// MARK: - Main Analytics View
struct AnalyticsView: View {
    @StateObject private var viewModel: AnalyticsViewModel
    @Environment(\.presentationMode) var presentationMode
    
    private enum AnalyticsTab: String, CaseIterable {
        case summary = "经营汇总"
        case products = "商品分析"
        case customers = "批发客"
    }
    @State private var selectedTab: AnalyticsTab = .summary
    
    init(orders: [Order]) {
        _viewModel = StateObject(wrappedValue: AnalyticsViewModel(orders: orders))
    }
    
    var body: some View {
        NavigationView {
            VStack(spacing: 0) {
                Picker("分析模块", selection: $selectedTab) {
                    ForEach(AnalyticsTab.allCases, id: \.self) { tab in
                        Text(tab.rawValue).tag(tab)
                    }
                }
                .pickerStyle(.segmented)
                .padding([.horizontal, .top])
                
                if selectedTab == .customers {
                    CustomerFilterView(viewModel: viewModel)
                } else {
                    MainFilterView(viewModel: viewModel)
                }
                
                Divider()

                switch selectedTab {
                case .summary:
                    BusinessSummaryView(viewModel: viewModel)
                case .products:
                    ProductAnalysisView(viewModel: viewModel)
                case .customers:
                    CustomerAnalysisView(viewModel: viewModel)
                }
            }
            .background(Color(.systemGroupedBackground))
            .navigationTitle("数据分析")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("关闭") {
                        presentationMode.wrappedValue.dismiss()
                    }
                }
            }
        }
    }
}

// MARK: - Filter Views
struct MainFilterView: View {
    @ObservedObject var viewModel: AnalyticsViewModel
    @State private var showingCustomDateRangePicker = false
    
    var body: some View {
        VStack(spacing: 12) {
            Picker("时间粒度", selection: $viewModel.granularity) {
                ForEach(AnalyticsViewModel.TimeGranularity.allCases) { Text($0.rawValue).tag($0) }
            }
            .pickerStyle(.segmented)
            .onChange(of: viewModel.granularity) {
                viewModel.customDateRange = nil
            }
            
            HStack(spacing: 0) {
                Button(action: { viewModel.moveToPreviousPeriod() }) {
                    Image(systemName: "chevron.left").padding()
                }.disabled(viewModel.customDateRange != nil)

                datePickerLabel()
                
                Button(action: { viewModel.moveToNextPeriod() }) {
                    Image(systemName: "chevron.right").padding()
                }.disabled(viewModel.customDateRange != nil)

                Spacer(minLength: 10)
                
                Menu {
                    Button("自定义范围") { showingCustomDateRangePicker = true }
                    Divider()
                    Picker("客户类型", selection: $viewModel.customerType) {
                        Text("全部客户").tag(CustomerType?(nil))
                        ForEach(CustomerType.allCases, id: \.self) { Text($0.displayTitle).tag(CustomerType?($0)) }
                    }
                } label: { FilterButton(label: viewModel.customerType?.displayTitle ?? "全部客户") }

                Menu {
                    Picker("数据对比", selection: $viewModel.comparisonType) {
                        ForEach(AnalyticsViewModel.ComparisonType.allCases) { Text($0.rawValue).tag($0) }
                    }.disabled(viewModel.customDateRange != nil)
                } label: { FilterButton(label: viewModel.comparisonType.rawValue) }
            }
        }
        .padding()
        .sheet(isPresented: $showingCustomDateRangePicker) {
            CustomDateRangePicker(dateRange: $viewModel.customDateRange)
        }
    }
    
    @ViewBuilder
    private func datePickerLabel() -> some View {
        Text(viewModel.selectedDateLabel)
            .font(.subheadline.weight(.semibold))
            .foregroundColor(.accentColor)
            .frame(maxWidth: .infinity)
            .frame(height: 36)
            .background(Color.accentColor.opacity(0.1))
            .cornerRadius(8)
            .overlay(
                DatePicker("选择周期", selection: $viewModel.selectedDate, displayedComponents: .date)
                    .blendMode(.destinationOver)
                    .disabled(viewModel.customDateRange != nil)
            )
    }
}

struct CustomerFilterView: View {
    @ObservedObject var viewModel: AnalyticsViewModel
    var body: some View {
        HStack {
            Menu {
                Picker("选择客户", selection: $viewModel.selectedCustomerName) {
                    Text("所有批发客户").tag(String?(nil))
                    ForEach(viewModel.wholesaleCustomerNames, id: \.self) { name in Text(name).tag(String?(name)) }
                }
            } label: {
                HStack(spacing: 8) {
                    Image(systemName: "person.3.sequence.fill")
                    Text(viewModel.selectedCustomerName ?? "所有批发客户")
                }
                .font(.headline)
                .foregroundColor(.accentColor)
                .padding(.vertical, 8)
                .padding(.horizontal)
                .background(Color.accentColor.opacity(0.1))
                .cornerRadius(10)
            }
            Spacer()
        }
        .padding()
    }
}

struct CustomDateRangePicker: View {
    @Binding var dateRange: ClosedRange<Date>?
    @Environment(\.presentationMode) var presentationMode
    
    @State private var startDate: Date
    @State private var endDate: Date
    
    init(dateRange: Binding<ClosedRange<Date>?>) {
        self._dateRange = dateRange
        let today = Date()
        let existingRange = dateRange.wrappedValue ?? today...today
        self._startDate = State(initialValue: existingRange.lowerBound)
        self._endDate = State(initialValue: existingRange.upperBound)
    }
    
    var body: some View {
        NavigationView {
            Form {
                DatePicker("开始日期", selection: $startDate, displayedComponents: .date)
                DatePicker("结束日期", selection: $endDate, in: startDate..., displayedComponents: .date)
            }
            .navigationTitle("选择日期范围")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) { Button("取消") { presentationMode.wrappedValue.dismiss() } }
                ToolbarItem(placement: .navigationBarTrailing) { Button("确定") {
                    dateRange = startDate...endDate
                    presentationMode.wrappedValue.dismiss()
                } }
            }
        }
    }
}

struct FilterButton: View {
    let label: String
    var body: some View {
        HStack(spacing: 4) {
            Text(label)
            Image(systemName: "chevron.down")
        }
        .font(.caption.bold())
        .foregroundColor(.primary)
        .padding(.horizontal, 10)
        .frame(height: 36)
        .background(Color(.systemGray5))
        .cornerRadius(8)
    }
}

// MARK: - Business Summary, Product, Customer Views
struct BusinessSummaryView: View {
    @ObservedObject var viewModel: AnalyticsViewModel
    private let columns = [GridItem(.flexible(), spacing: 15), GridItem(.flexible(), spacing: 15)]
    
    var body: some View {
        ScrollView {
            VStack(alignment: .leading, spacing: 15) {
                LazyVGrid(columns: columns, spacing: 15) {
                    KpiCard(title: "销售金额", value: String(format: "¥%.2f", viewModel.summaryData.revenue), change: viewModel.summaryData.revenueChange, icon: "yensign.circle.fill", color: .blue)
                    KpiCard(title: "销售单数", value: "\(viewModel.summaryData.orderCount)", change: viewModel.summaryData.orderCountChange, icon: "doc.text.fill", color: .indigo)
                    KpiCard(title: "销售件数", value: "\(viewModel.summaryData.unitsSold)", change: viewModel.summaryData.unitsSoldChange, icon: "shippingbox.fill", color: .orange)
                    KpiCard(title: "客户数", value: "\(viewModel.summaryData.customerCount)", change: viewModel.summaryData.customerCountChange, icon: "person.2.fill", color: .green)
                }
                .padding(.horizontal)
                
                InteractiveBarChartView(
                    title: "销售金额趋势 (\(viewModel.customerType?.displayTitle ?? "全部"))",
                    data: viewModel.chartData,
                    granularity: viewModel.granularity
                )
            }
            .padding(.top)
        }
    }
}

struct KpiCard: View {
    let title: String, value: String, change: Double?, icon: String, color: Color
    
    var body: some View {
        VStack(alignment: .leading, spacing: 8) {
            HStack {
                Image(systemName: icon).font(.headline).foregroundColor(color)
                Text(title).font(.subheadline).foregroundColor(.secondary)
                Spacer()
            }
            Text(value).font(.system(.title, design: .rounded).bold()).foregroundColor(.primary)
            if let change = change {
                HStack(spacing: 4) {
                    Image(systemName: change >= 0 ? "arrow.up.right" : "arrow.down.right")
                    Text(String(format: "%.1f%%", abs(change * 100)))
                }
                .font(.footnote.weight(.semibold)).foregroundColor(change >= 0 ? .green : .red)
            } else { Text("-").font(.footnote).foregroundColor(.clear) }
        }
        .padding().background(Color(.systemBackground)).cornerRadius(12).shadow(color: .black.opacity(0.05), radius: 4, y: 2)
    }
}

struct ProductAnalysisView: View {
    @ObservedObject var viewModel: AnalyticsViewModel
    enum ProductRankType: String, CaseIterable, Identifiable { case byRevenue = "按销售额", byQuantity = "按销量", byColor = "按颜色", bySize = "按尺码"; var id: String { self.rawValue } }
    @State private var rankType: ProductRankType = .byRevenue
    
    var body: some View {
        VStack(spacing: 0) {
            Picker("排行依据", selection: $rankType) {
                ForEach(ProductRankType.allCases) { Text($0.rawValue).tag($0) }
            }.pickerStyle(.segmented).padding()

            List {
                switch rankType {
                case .byRevenue:
                    RankSection(title: "按销售额", items: viewModel.productAnalysisByRevenue, content: { product in
                        Text("销售额: ¥\(String(format: "%.0f", product.totalRevenue)) | 销量: \(product.totalQuantity)件").font(.subheadline).foregroundColor(.secondary)
                    }, primaryText: { Text($0.productName) })
                case .byQuantity:
                    RankSection(title: "按销量", items: viewModel.productAnalysisByQuantity, content: { product in
                        Text("销量: \(product.totalQuantity)件 | 销售额: ¥\(String(format: "%.0f", product.totalRevenue))").font(.subheadline).foregroundColor(.secondary)
                    }, primaryText: { Text($0.productName) })
                case .byColor:
                    RankSection(title: "按颜色", items: viewModel.colorRanking, content: { color in
                        Text("销量: \(color.quantity) 件").font(.subheadline).foregroundColor(.secondary)
                    }, primaryText: { Text($0.color) })
                case .bySize:
                    RankSection(title: "按尺码", items: viewModel.sizeRanking, content: { size in
                        Text("销量: \(size.quantity) 件").font(.subheadline).foregroundColor(.secondary)
                    }, primaryText: { Text($0.size) })
                }
            }.listStyle(.insetGrouped)
        }
    }
}

struct RankSection<Item: Identifiable, Content: View, PrimaryText: View>: View {
    let title: String; let items: [Item]
    @ViewBuilder let content: (Item) -> Content; @ViewBuilder let primaryText: (Item) -> PrimaryText
    
    var body: some View {
        Section(header: Text(title)) {
            if items.isEmpty {
                Text("无数据").foregroundColor(.secondary)
            } else {
                ForEach(Array(items.enumerated()), id: \.element.id) { index, item in
                    HStack(alignment: .top, spacing: 10) {
                        Text("\(index + 1).").font(.headline).frame(width: 30, alignment: .leading)
                        VStack(alignment: .leading, spacing: 5) {
                            primaryText(item).font(.headline)
                            content(item)
                        }
                    }.padding(.vertical, 5)
                }
            }
        }
    }
}

struct CustomerAnalysisView: View {
    @ObservedObject var viewModel: AnalyticsViewModel
    var body: some View {
        ScrollView {
            VStack(alignment: .leading, spacing: 15) {
                let summary = viewModel.customerSummaryData; let columns = [GridItem(.flexible(), spacing: 15), GridItem(.flexible(), spacing: 15)]
                LazyVGrid(columns: columns, spacing: 15) {
                    KpiCard(title: "总销售额", value: String(format: "¥%.2f", summary.revenue), change: nil, icon: "yensign.circle.fill", color: .blue)
                    KpiCard(title: "总订单数", value: "\(summary.orderCount)", change: nil, icon: "doc.text.fill", color: .indigo)
                }
                
                VStack {
                    if filteredCustomerData().isEmpty {
                        Text("无客户月度数据").foregroundColor(.gray).padding().frame(maxWidth: .infinity)
                    } else {
                        ForEach(filteredCustomerData()) { customer in
                            VStack(alignment: .leading) {
                                Text(customer.customerName).font(.title3.bold()).padding(.top)
                                ForEach(customer.monthlyData, id: \.self) { monthData in
                                    VStack(alignment: .leading, spacing: 4) {
                                        Text(monthData.month, format: .dateTime.year().month(.wide)).font(.headline)
                                        Text("订单: \(monthData.orderCount) | 件数: \(monthData.unitsSold) | 金额: ¥\(String(format: "%.0f", monthData.revenue))").font(.subheadline)
                                        if !monthData.topProducts.isEmpty { Text("热销品: \(monthData.topProducts.joined(separator: ", "))").font(.caption).foregroundColor(.secondary) }
                                    }
                                    .padding().frame(maxWidth: .infinity, alignment: .leading)
                                    .background(Color(.systemBackground)).cornerRadius(10)
                                    .padding(.bottom, 5)
                                }
                            }
                        }
                    }
                }
            }.padding()
        }
    }
    
    private func filteredCustomerData() -> [CustomerAnalysisData] {
        if let name = viewModel.selectedCustomerName { return viewModel.customerAnalysis.filter { $0.customerName == name } }
        return viewModel.customerAnalysis
    }
}


// MARK: - Interactive Chart
struct InteractiveBarChartView: View {
    let title: String
    let data: [ChartSegment]
    let granularity: AnalyticsViewModel.TimeGranularity
    
    @State private var showingFullScreenChart = false
    @State private var selectedDate: Date?

    private var selectedSegment: ChartSegment? {
        guard let selectedDate else { return nil }
        return data.min { abs($0.date.timeIntervalSince(selectedDate)) < abs($1.date.timeIntervalSince(selectedDate)) }
    }
    
    private var visibleDomainLength: Double {
        let day: Double = 3600 * 24
        switch granularity {
        case .day: return day * 30
        case .week: return day * 365 / 2
        case .month: return day * 365 * 1.5
        case .quarter: return day * 365 * 3
        case .year: return day * 365 * 8
        }
    }
    
    var body: some View {
        VStack(alignment: .leading, spacing: 12) {
            chartHeader
            if data.isEmpty {
                emptyStateView
            } else {
                chartContent
            }
        }
        .padding([.horizontal, .top])
        .background(Color(.systemBackground))
        .cornerRadius(12)
        .shadow(color: .black.opacity(0.05), radius: 4, y: 2)
        .sheet(isPresented: $showingFullScreenChart) {
            FullScreenChartView(title: title, data: data, unit: granularity.calendarComponent)
        }
    }
    
    private var chartHeader: some View {
        HStack {
            Text(title).font(.headline)
            Spacer()
            Button(action: { showingFullScreenChart = true }) {
                Image(systemName: "arrow.up.left.and.arrow.down.right")
            }
            .disabled(data.isEmpty)
        }
    }
    
    private var emptyStateView: some View {
        VStack {
            Spacer()
            Text("无销售数据").font(.caption).foregroundColor(.gray)
            Spacer()
        }
        .frame(height: 250, alignment: .center)
    }

    @ViewBuilder
    private var chartContent: some View {
        ScrollViewReader { proxy in
            Chart {
                ForEach(data) { segment in
                    BarMark(
                        x: .value("日期", segment.date, unit: granularity.calendarComponent),
                        y: .value("金额", segment.wholesaleValue)
                    ).foregroundStyle(by: .value("客户类型", "批发客"))
                    
                    BarMark(
                        x: .value("日期", segment.date, unit: granularity.calendarComponent),
                        y: .value("金额", segment.retailValue)
                    ).foregroundStyle(by: .value("客户类型", "零售客"))
                }
                
                if let selectedDate {
                    RuleMark(x: .value("选中", selectedDate))
                        .foregroundStyle(Color.gray.opacity(0.8))
                        .lineStyle(StrokeStyle(lineWidth: 1.5))
                        .zIndex(1)
                }
            }
            .chartScrollableAxes(.horizontal)
            .chartXVisibleDomain(length: visibleDomainLength)
            .chartXAxis(content: {
                switch self.granularity {
                case .day, .week:
                    AxisMarks(values: .stride(by: .month, count: 1)) { value in
                        AxisGridLine()
                        AxisTick()
                        AxisValueLabel(format: .dateTime.month(.abbreviated))
                    }
                case .month:
                    AxisMarks(values: .stride(by: .month, count: 6)) { value in
                        AxisGridLine()
                        AxisTick()
                        AxisValueLabel(format: .dateTime.month(.abbreviated))
                    }
                case .quarter:
                    AxisMarks(values: .stride(by: .year, count: 1)) { value in
                        AxisGridLine()
                        AxisTick()
                        AxisValueLabel(format: .dateTime.year(.twoDigits).quarter(.oneDigit))
                    }
                case .year:
                    AxisMarks(values: .stride(by: .year, count: 1)) { value in
                        AxisGridLine()
                        AxisTick()
                        AxisValueLabel(format: .dateTime.year())
                    }
                }
            })
            .chartYAxis { AxisMarks() }
            .frame(height: 250)
            .chartXSelection(value: $selectedDate)
            .overlay(alignment: .top) {
                if let selectedSegment {
                    TooltipView(segment: selectedSegment, granularity: granularity)
                        .padding(.vertical, 8)
                        .transition(.opacity.animation(.easeInOut))
                }
            }
            .task(id: data.count) {
                if let lastDate = data.last?.date {
                    try? await Task.sleep(nanoseconds: 10_000_000)
                    proxy.scrollTo(lastDate, anchor: .trailing)
                }
            }
        }
    }
}

// MARK: - Tooltip & FullScreenChart
struct TooltipView: View {
    let segment: ChartSegment
    let granularity: AnalyticsViewModel.TimeGranularity
    
    private func formattedDateString() -> String {
        let formatter = DateFormatter()
        formatter.locale = Locale(identifier: "zh_CN")
        
        switch granularity {
        case .day:
            formatter.dateFormat = "yyyy/M/d EEEE"
            return formatter.string(from: segment.date)
        case .week:
            guard let weekInterval = Calendar.current.dateInterval(of: .weekOfYear, for: segment.date) else {
                return "N/A"
            }
            let start = weekInterval.start
            let end = weekInterval.end.addingTimeInterval(-1)
            formatter.dateFormat = "M/d"
            return "\(formatter.string(from: start)) - \(formatter.string(from: end))"
        case .month:
            formatter.dateFormat = "yyyy年 M月"
            return formatter.string(from: segment.date)
        case .quarter:
            let quarter = Calendar.current.component(.quarter, from: segment.date)
            formatter.dateFormat = "yyyy年"
            return "\(formatter.string(from: segment.date)) Q\(quarter)"
        case .year:
            formatter.dateFormat = "yyyy年"
            return formatter.string(from: segment.date)
        }
    }

    var body: some View {
        VStack(alignment: .leading, spacing: 4) {
            Text(formattedDateString())
                .font(.caption.bold())
                .foregroundColor(.primary)
            
            Divider().padding(.vertical, 2)
            
            Grid(alignment: .leading, horizontalSpacing: 8, verticalSpacing: 4) {
                GridRow {
                    Text("总金额:").gridColumnAlignment(.leading)
                    Text("¥\(String(format: "%.2f", segment.totalValue))").gridColumnAlignment(.trailing)
                }
                GridRow {
                    HStack(spacing: 4) {
                        Circle().fill(Color.green.opacity(0.8)).frame(width: 8, height: 8)
                        Text("批发客:")
                    }
                    Text("¥\(String(format: "%.0f", segment.wholesaleValue)) (\(segment.wholesaleOrderCount)单)").gridColumnAlignment(.trailing)
                }
                GridRow {
                    HStack(spacing: 4) {
                        Circle().fill(Color.blue.opacity(0.8)).frame(width: 8, height: 8)
                        Text("零售客:")
                    }
                    Text("¥\(String(format: "%.0f", segment.retailValue)) (\(segment.retailOrderCount)单)").gridColumnAlignment(.trailing)
                }
            }
            .font(.caption)
            .foregroundColor(.secondary)
        }
        .padding(10)
        .background(Material.thin)
        .cornerRadius(10)
        .shadow(color: .black.opacity(0.15), radius: 5)
        .frame(width: 175)
    }
}

struct FullScreenChartView: View {
    let title: String
    let data: [ChartSegment]
    let unit: Calendar.Component
    @Environment(\.presentationMode) var presentationMode

    var body: some View {
        NavigationView {
            VStack {
                Chart {
                    ForEach(data) { segment in
                        BarMark(
                            x: .value("日期", segment.date, unit: unit),
                            y: .value("金额", segment.wholesaleValue)
                        ).foregroundStyle(by: .value("客户类型", "批发客"))
                        
                        BarMark(
                            x: .value("日期", segment.date, unit: unit),
                            y: .value("金额", segment.retailValue)
                        ).foregroundStyle(by: .value("客户类型", "零售客"))
                    }
                }
                .chartForegroundStyleScale([
                    "批发客": Color.green.gradient,
                    "零售客": Color.blue.gradient
                ])
                .chartXAxis {
                     AxisMarks(values: .stride(by: .weekOfYear)) { value in
                        AxisGridLine()
                        AxisTick()
                        if let date = value.as(Date.self) {
                            AxisValueLabel(format: .dateTime.month().day())
                        }
                    }
                }
                .padding()
                .navigationTitle(title)
                .navigationBarTitleDisplayMode(.inline)
                .toolbar {
                    ToolbarItem(placement: .navigationBarTrailing) {
                        Button("完成") { presentationMode.wrappedValue.dismiss() }
                    }
                }
            }
            .forceLandscape()
        }
        .navigationViewStyle(.stack)
    }
}

struct LandscapeViewModifier: ViewModifier {
    func body(content: Content) -> some View {
        content
            .onAppear {
                if let windowScene = UIApplication.shared.connectedScenes.first as? UIWindowScene {
                    windowScene.requestGeometryUpdate(.iOS(interfaceOrientations: .landscape)) { error in
                        print("Error requesting geometry update for landscape: \(error.localizedDescription)")
                    }
                }
                AppDelegate.orientationLock = .landscape
            }
            .onDisappear {
                if let windowScene = UIApplication.shared.connectedScenes.first as? UIWindowScene {
                     windowScene.requestGeometryUpdate(.iOS(interfaceOrientations: .portrait)) { error in
                        print("Error requesting geometry update for portrait: \(error.localizedDescription)")
                    }
                }
                AppDelegate.orientationLock = .portrait
            }
    }
}

extension View {
    func forceLandscape() -> some View {
        self.modifier(LandscapeViewModifier())
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/UserSettings.swift
// ==========================================

// UserSettings.swift

import Foundation
import Combine

// 一个遵循 ObservableObject 协议的类，用于管理所有用户可配置的设置。
// @MainActor 确保所有对 @Published 属性的更新都在主线程上进行。
@MainActor
class UserSettings: ObservableObject {
    
    // 我们将使用这个 key 在 UserDefaults 中存储用户的字体缩放设置
    private let fontScaleMultiplierKey = "userFontScaleMultiplier"
    
    // 使用 @Published 属性包装器，这样任何监听此对象的 SwiftUI 视图都会在它改变时自动刷新。
    @Published var fontScaleMultiplier: Double {
        didSet {
            // 每当 fontScaleMultiplier 的值被改变时，我们就将新值保存到 UserDefaults。
            UserDefaults.standard.set(fontScaleMultiplier, forKey: fontScaleMultiplierKey)
        }
    }
    
    init() {
        // 在类初始化时，我们尝试从 UserDefaults 加载之前保存的设置。
        // 如果找不到（比如用户第一次打开App），就使用默认值 1.0。
        let savedMultiplier = UserDefaults.standard.double(forKey: fontScaleMultiplierKey)
        
        // UserDefaults 在找不到 double 值时会返回 0.0，所以我们需要检查一下。
        if savedMultiplier == 0.0 {
            self.fontScaleMultiplier = 1.0
        } else {
            self.fontScaleMultiplier = savedMultiplier
        }
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/SideMenuView.swift
// ==========================================

import SwiftUI

struct PlainDisclosureGroupStyle: DisclosureGroupStyle {
    func makeBody(configuration: Configuration) -> some View {
        VStack(alignment: .leading, spacing: 0) {
            configuration.label
                .contentShape(Rectangle())
                .onTapGesture {
                    withAnimation(.spring()) {
                        configuration.isExpanded.toggle()
                    }
                }
            
            if configuration.isExpanded {
                configuration.content
                    .transition(.opacity.combined(with: .move(edge: .top)))
            }
        }
    }
}


struct SideMenuView: View {
    @EnvironmentObject var viewModel: OrderViewModel
    @EnvironmentObject var userSettings: UserSettings
    
    @Binding var showTrashView: Bool
    @Binding var showSideMenu: Bool
    @Binding var showCashConfirmation: Bool
    
    @State private var showingBackupView = false
    @State private var isFontAdjusterExpanded = false
    @State private var showingRefundedView = false
    @State private var showingShipmentTracking = false
    
    var onToggleMultiSelectDelete: () -> Void
    var onShowDatabase: () -> Void
    var onShowAnalytics: () -> Void
    
    var body: some View {
        List {
            Section {
                Text("操作菜单")
                    .font(.largeTitle.bold())
                    .padding(.vertical, 10)
            }
            .listRowBackground(Color.clear)

            Section {
                menuButton(icon: "archivebox.circle.fill", text: "备份与恢复") { showingBackupView = true }
                menuButton(icon: "dollarsign.circle.fill", text: "现金对账") { showCashConfirmation = true }
                menuButton(icon: "chart.pie.fill", text: "数据分析", action: onShowAnalytics)
                
                // MARK: - 新增功能按钮
                menuButton(icon: "shippingbox.and.arrow.backward.fill", text: "出货追踪") { showingShipmentTracking = true }
                
                menuButton(icon: "server.rack", text: "数据库", action: onShowDatabase)
            }

            Section {
                DisclosureGroup(isExpanded: $isFontAdjusterExpanded) {
                    HStack(spacing: 15) {
                        Image(systemName: "textformat.size.smaller")
                        Slider(value: $userSettings.fontScaleMultiplier, in: 0.8...1.5, step: 0.05)
                        Image(systemName: "textformat.size.larger")
                    }
                    .padding(.top, 10)
                } label: {
                    Label("列表字体大小 (\(Int(userSettings.fontScaleMultiplier * 100))%)", systemImage: "textformat.size")
                }
                .accentColor(.primary)
            }

            Section(header: Text("订单管理")) {
                let refundedCount = viewModel.orders.filter { $0.status == .refunded }.count
                menuButton(icon: "arrow.uturn.backward.circle.fill", text: "退货退款 (\(refundedCount))") {
                    showingRefundedView = true
                }
                menuButton(icon: "checklist", text: "选择订单删除", action: onToggleMultiSelectDelete)
                menuButton(icon: "trash.fill", text: "垃圾桶 (\(viewModel.deletedOrders.count))") { showTrashView = true }
            }
        }
        .listStyle(.insetGrouped)
        .onChange(of: showSideMenu) { oldState, newState in
            if newState {
                isFontAdjusterExpanded = false
            }
        }
        .sheet(isPresented: $showingBackupView) {
            BackupAndRestoreView().environmentObject(viewModel)
        }
        .sheet(isPresented: $showingRefundedView) {
            RefundedOrdersView().environmentObject(viewModel)
        }
        // MARK: - 新增 sheet
        .sheet(isPresented: $showingShipmentTracking) {
            ShipmentTrackingView().environmentObject(viewModel)
        }
    }
    
    private func menuButton(icon: String, text: String, action: @escaping () -> Void) -> some View {
        Button(action: {
            action()
            DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) {
                withAnimation { showSideMenu = false }
            }
        }) {
            Label(text, systemImage: icon)
        }
        .foregroundColor(.primary)
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/FullScreenImageViewer.swift
// ==========================================

// FullScreenImageViewer.swift
import SwiftUI

// 一个通用的、可包含自定义工具栏操作的全屏图片预览器
struct FullScreenImageViewer<Toolbar: View>: View {
    @Environment(\.presentationMode) var presentationMode
    
    let image: UIImage
    let toolbarContent: Toolbar

    init(image: UIImage, @ViewBuilder toolbarContent: () -> Toolbar) {
        self.image = image
        self.toolbarContent = toolbarContent()
    }

    var body: some View {
        // 使用 NavigationView 来方便地添加导航栏和按钮
        NavigationView {
            // 使用 ScrollView 来确保长图可以完整滚动查看
            ScrollView {
                Image(uiImage: image)
                    .resizable()
                    .scaledToFit()
            }
            .background(Color.black) // 设置黑色背景
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                // 左侧关闭按钮
                ToolbarItem(placement: .navigationBarLeading) {
                    Button("关闭") {
                        presentationMode.wrappedValue.dismiss()
                    }
                }
                
                // 右侧自定义操作按钮
                ToolbarItem(placement: .navigationBarTrailing) {
                    toolbarContent
                }
            }
        }
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/ImageGalleryView.swift
// ==========================================

// ImageGalleryView.swift

import SwiftUI

struct ImageGalleryView: View {
    // 绑定当前显示的订单，当设为 nil 时，视图消失
    @Binding var selectedOrder: Order?
    
    // 动画命名空间
    var namespace: Namespace.ID

    // 当前页面的ID，通过 @State 和 .scrollPosition 实现双向绑定
    @State private var currentPageId: String?
    
    // 手势状态
    @State private var dragOffset: CGSize = .zero
    @State private var backgroundOpacity: Double = 1.0

    // 计算属性，获取所有图片ID
    private var allImageIds: [String] {
        selectedOrder?.orderItems.flatMap { $0.productImageIdentifiers } ?? []
    }

    var body: some View {
        ZStack {
            // 半透明背景，点击可关闭
            Color.black.opacity(backgroundOpacity)
                .ignoresSafeArea()
                .onTapGesture(perform: closeGallery)

            VStack(spacing: 0) {
                // --- 关闭按钮 ---
                HStack {
                    Spacer()
                    Button(action: closeGallery) {
                        Image(systemName: "xmark")
                            .font(.body.weight(.bold))
                            .foregroundColor(.white)
                            .padding(12)
                            .background(Color.white.opacity(0.2))
                            .clipShape(Circle())
                    }
                }
                .padding()
                .opacity(backgroundOpacity)

                Spacer()

                // --- 主图区域：使用带 .scrollPosition 绑定的 ScrollView ---
                ScrollView(.horizontal) {
                    LazyHStack(spacing: 0) {
                        ForEach(allImageIds, id: \.self) { imageId in
                            if let image = ImageStore.shared.loadImage(withIdentifier: imageId) {
                                Image(uiImage: image)
                                    .resizable()
                                    .scaledToFit()
                                    .matchedGeometryEffect(id: "image_\(imageId)", in: namespace)
                                    .containerRelativeFrame(.horizontal)
                                    .id(imageId) // 必须有 ID 才能被 scrollPosition 追踪
                            }
                        }
                    }
                    .scrollTargetLayout()
                }
                .scrollTargetBehavior(.paging) // 开启分页滚动效果
                .scrollIndicators(.hidden) // 隐藏滚动条
                .scrollPosition(id: $currentPageId, anchor: .center) // 双向绑定滚动位置和状态
                .offset(y: dragOffset.height) // 跟随手势垂直移动
                
                Spacer()

                // --- 缩略图预览条 ---
                thumbnailScrollView
                    .opacity(backgroundOpacity)
            }
        }
        .gesture(
            DragGesture()
                .onChanged(handleDragChanged)
                .onEnded(handleDragEnded)
        )
        .onAppear {
            if currentPageId == nil {
                currentPageId = allImageIds.first
            }
        }
    }
    
    // --- 缩略图滚动视图 ---
    @ViewBuilder
    private var thumbnailScrollView: some View {
        // 只有多于一张图时才显示
        if allImageIds.count > 1 {
            ScrollViewReader { proxy in
                ScrollView(.horizontal, showsIndicators: false) {
                    HStack(spacing: 10) {
                        ForEach(allImageIds, id: \.self) { imageId in
                            if let image = ImageStore.shared.loadImage(withIdentifier: imageId) {
                                Image(uiImage: image)
                                    .resizable()
                                    .scaledToFill()
                                    .frame(width: 50, height: 50)
                                    .clipShape(RoundedRectangle(cornerRadius: 6))
                                    .id(imageId) // ID for ScrollViewReader
                                    .overlay(
                                        // 高亮当前选中的缩略图
                                        RoundedRectangle(cornerRadius: 6)
                                            .stroke(currentPageId == imageId ? Color.white : Color.clear, lineWidth: 2)
                                    )
                                    .onTapGesture {
                                        // 点击小图，直接更新 currentPageId
                                        // 主 ScrollView 会因为绑定而自动滚动
                                        withAnimation(.spring()) {
                                            currentPageId = imageId
                                        }
                                    }
                            }
                        }
                    }
                    .padding(.horizontal)
                }
                .frame(height: 70)
                .onChange(of: currentPageId) { _, newId in
                    // 当 currentPageId 改变时（无论是滑动主图还是点击小图），
                    // 都让缩略图列表滚动到对应位置
                    withAnimation {
                        proxy.scrollTo(newId, anchor: .center)
                    }
                }
            }
        }
    }
    
    // --- 手势处理函数 ---
    private func handleDragChanged(_ value: DragGesture.Value) {
        // 只响应向下的拖动
        if value.translation.height > 0 {
            dragOffset = value.translation
            // 根据拖动距离计算背景透明度
            let dragDistance = value.translation.height
            backgroundOpacity = max(0, 1 - (dragDistance / 400))
        }
    }
    
    private func handleDragEnded(_ value: DragGesture.Value) {
        let dragDistance = value.translation.height
        // 如果拖动距离超过阈值，则关闭
        if dragDistance > 100 {
            closeGallery()
        } else {
            // 否则，弹回原位
            withAnimation(.interactiveSpring()) {
                dragOffset = .zero
                backgroundOpacity = 1.0
            }
        }
    }

    // --- 关闭画廊的函数 ---
    private func closeGallery() {
        withAnimation(.spring(response: 0.4, dampingFraction: 0.9)) {
            dragOffset = .zero
            backgroundOpacity = 0
            selectedOrder = nil
        }
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/CashConfirmationView.swift
// ==========================================

// CashConfirmationView.swift
// 已移除重复的 statusTag 函数定义

import SwiftUI

struct CashConfirmationView: View {
    @EnvironmentObject var viewModel: OrderViewModel
    @EnvironmentObject var userSettings: UserSettings
    @Environment(\.presentationMode) var presentationMode
    
    @Namespace private var cashConfirmationNamespace
    
    @State private var searchText = ""
    @State private var selectedOrder: Order?

    private var unconfirmedOrders: [Order] {
        viewModel.orders
            .filter { ($0.status ?? .active) == .active && $0.paymentStatus != .paid }
    }
    
    private var filteredOrders: [Order] {
        if searchText.isEmpty {
            return unconfirmedOrders
        } else {
            return unconfirmedOrders.filter {
                $0.customerName.localizedCaseInsensitiveContains(searchText) ||
                $0.orderNumber.localizedCaseInsensitiveContains(searchText)
            }
        }
    }
    
    var body: some View {
        GeometryReader { geometry in
            NavigationView {
                mainContent(screenWidth: geometry.size.width)
                    .listStyle(.plain)
                    .navigationTitle("现金对账")
                    .searchable(text: $searchText, prompt: "搜索客户或订单号")
                    .toolbar {
                        ToolbarItem(placement: .navigationBarTrailing) {
                            Button("完成") { presentationMode.wrappedValue.dismiss() }
                        }
                    }
                    .sheet(item: $selectedOrder) { orderToEdit in
                        if let index = viewModel.orders.firstIndex(where: { $0.id == orderToEdit.id }) {
                            NavigationView {
                                OrderDetailView(order: $viewModel.orders[index])
                            }
                            .environmentObject(viewModel)
                            .environmentObject(userSettings)
                        }
                    }
            }
        }
    }
    
    // MARK: - 辅助视图构建器
    
    @ViewBuilder
    private func mainContent(screenWidth: CGFloat) -> some View {
        List {
            Section {
                summaryCard
            }
            .id(userSettings.fontScaleMultiplier)
            .listRowInsets(EdgeInsets())
            .listRowSeparator(.hidden)
            .listRowBackground(Color.clear)

            if filteredOrders.isEmpty {
                Section {
                    emptyStateView
                }
            } else {
                orderListSection(screenWidth: screenWidth)
            }
        }
    }
    
    @ViewBuilder
    private func orderListSection(screenWidth: CGFloat) -> some View {
        Section(header: Text("待处理订单 (\(filteredOrders.count))")) {
            ForEach(filteredOrders) { order in
                CashConfirmationRow(
                    order: order,
                    screenWidth: screenWidth,
                    namespace: cashConfirmationNamespace
                )
                .onTapGesture {
                    self.selectedOrder = order
                }
            }
        }
    }
    
    @ViewBuilder
    private var summaryCard: some View {
        VStack(alignment: .leading, spacing: 15) {
            HStack {
                Image(systemName: "hourglass.circle.fill").font(.title2).foregroundColor(.orange)
                Text("待收总额").font(.headline)
                Spacer()
                Text("¥\(String(format: "%.2f", viewModel.unconfirmedBalanceDue))").font(.system(.title, design: .rounded).bold()).foregroundColor(.orange)
            }
            Divider()
            HStack {
                SummaryStatItem(title: "总营收", value: "¥\(String(format: "%.2f", viewModel.totalRevenue))")
                Spacer()
                SummaryStatItem(title: "已收总额", value: "¥\(String(format: "%.2f", viewModel.totalPaidAmount))")
                Spacer()
                SummaryStatItem(title: "待收单数", value: "\(unconfirmedOrders.count) 单")
            }
        }
        .padding().background(Color(.systemBackground)).cornerRadius(12).shadow(color: .black.opacity(0.05), radius: 5, y: 2).padding()
    }

    @ViewBuilder
    private var emptyStateView: some View {
        VStack(spacing: 20) {
            Spacer(minLength: 80)
            Image(systemName: "checkmark.seal.fill").font(.system(size: 70)).foregroundColor(.green)
            Text("账目清晰").font(.title.bold())
            Text("所有正常订单均已付清全款！").font(.body).foregroundColor(.secondary)
            Spacer()
        }
        .frame(maxWidth: .infinity).listRowBackground(Color.clear)
    }
}

private struct CashConfirmationRow: View {
    @EnvironmentObject var userSettings: UserSettings
    
    let order: Order
    let screenWidth: CGFloat
    let namespace: Namespace.ID

    var body: some View {
        ZStack(alignment: .topTrailing) {
            OrderRowView(
                order: order,
                screenWidth: screenWidth,
                fontScaleMultiplier: userSettings.fontScaleMultiplier,
                onImageTapped: { _ in },
                namespace: namespace
            )

            let status = order.paymentStatus
            statusTag(
                text: status.rawValue,
                color: .white,
                backgroundColor: status.color
            )
            .padding([.top, .trailing], 6)
        }
        .padding(.horizontal)
        .listRowInsets(EdgeInsets(top: 5, leading: 0, bottom: 5, trailing: 0))
        .listRowSeparator(.hidden)
    }
}


private struct SummaryStatItem: View {
    let title: String
    let value: String
    
    var body: some View {
        VStack(alignment: .leading, spacing: 4) {
            Text(title).font(.caption).foregroundColor(.secondary)
            Text(value).font(.callout.weight(.medium))
        }
    }
}

// <<< 核心修复点: 我已经删除了这里对 statusTag 的重复定义 >>>
// @ViewBuilder
// private func statusTag(...) -> some View { ... }


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/FactoryItemSelectionView.swift
// ==========================================


//FactoryItemSelectionView.swift

import SwiftUI

struct FactoryItemSelectionView: View {
    @State var order: Order

    var body: some View {
        Form {
            Section(header: Text("为哪个商品生成订单？")) {
                ForEach($order.orderItems) { $item in
                    NavigationLink(destination: FactoryOrderDetailView(order: order, item: $item)) {
                        VStack(alignment: .leading, spacing: 4) {
                            Text(item.productName).font(.headline)
                            Text("\(item.color) / \(item.leather)")
                                .font(.caption).foregroundColor(.secondary)
                            Text("数量: \(item.totalItemQuantity)")
                                .font(.caption)
                        }
                        .padding(.vertical, 4)
                    }
                }
            }
        }
        .navigationTitle("选择商品")
        .navigationBarTitleDisplayMode(.inline)
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/AddOrderItemView.swift
// ==========================================

// AddOrderItemView.swift

import SwiftUI
import PhotosUI

struct IdentifiableUIImage: Identifiable {
    let id = UUID(); let image: UIImage
}

struct AddOrderItemView: View {
    @Environment(\.presentationMode) var presentationMode
    
    @Binding var item: OrderItem
    var onSave: (OrderItem) -> Void

    // 本地状态
    @State private var unitPriceString: String
    @State private var existingImageIdentifiers: [String]
    @State private var selectedPhotoItems: [PhotosPickerItem] = []
    @State private var newlyLoadedImages: [IdentifiableUIImage] = []
    @State private var imageToPreview: UIImage?
    @State private var isPreviewingImage = false
    
    enum FocusableField: Hashable {
        case productName, color, leather, unitPrice, quantity(String)
    }
    @FocusState private var focusedField: FocusableField?

    private let allSizes = (33...42).map { "\($0)码" }
    private let columns = [GridItem(.adaptive(minimum: 70))]
    private let imageGridColumns = [GridItem(.adaptive(minimum: 100))]
    
    private var isFormValid: Bool {
        !item.productName.isEmpty && !item.color.isEmpty && !item.leather.isEmpty &&
        !item.sizeQuantities.filter { $0.value > 0 }.isEmpty
    }

    // 初始化器
    init(item: Binding<OrderItem>, onSave: @escaping (OrderItem) -> Void) {
        self._item = item
        self.onSave = onSave
        _unitPriceString = State(initialValue: item.wrappedValue.unitPrice > 0 ? String(format: "%.2f", item.wrappedValue.unitPrice) : "")
        _existingImageIdentifiers = State(initialValue: item.wrappedValue.productImageIdentifiers)
    }

    var body: some View {
        NavigationView {
            Form {
                Section(header: Text("商品规格").font(.headline)) {
                    TextField("商品名称*", text: $item.productName).focused($focusedField, equals: .productName)
                    TextField("颜色*", text: $item.color).focused($focusedField, equals: .color)
                    TextField("皮料*", text: $item.leather).focused($focusedField, equals: .leather)
                }

                Section(header: Text("选择尺码*").font(.headline)) {
                    LazyVGrid(columns: columns, spacing: 15) {
                        ForEach(allSizes, id: \.self) { size in
                            Button(action: { toggleSizeSelection(size) }) {
                                Text(size).font(.headline)
                                    .frame(minWidth: 0, maxWidth: .infinity, minHeight: 50)
                                    .background(item.sizeQuantities[size, default: 0] > 0 ? Color.accentColor : Color.gray.opacity(0.2))
                                    .foregroundColor(item.sizeQuantities[size, default: 0] > 0 ? .white : .primary)
                                    .cornerRadius(8)
                            }
                        }
                    }.buttonStyle(.plain)
                }
                
                if !item.sizeQuantities.filter({$0.value > 0}).isEmpty {
                    Section(header: Text("已选尺码和数量").font(.headline)) {
                        ForEach(item.sizeQuantities.keys.sorted(), id: \.self) { size in
                             HStack {
                                HStack(spacing: 4) { Text("\(size) 数量:"); TextField("", text: quantityBinding(for: size)).keyboardType(.numberPad).focused($focusedField, equals: .quantity(size)).frame(width: 50).foregroundColor(.accentColor).fontWeight(.medium) }
                                Spacer()
                                Stepper("", value: stepperBinding(for: size), in: 0...999)
                            }
                        }
                    }
                }

                Section(header: Text("类型与价格").font(.headline)) {
                    Picker("商品类型", selection: $item.productType.toUnwrapped(defaultValue: .custom)) {
                        ForEach(ProductType.allCases) { type in Text(type.rawValue).tag(type) }
                    }.pickerStyle(.segmented)
                    HStack {
                        Text("¥"); TextField("商品单价", text: $unitPriceString).keyboardType(.decimalPad).focused($focusedField, equals: .unitPrice)
                    }
                }
                
                Section(header: imageSectionHeader()) {
                    if existingImageIdentifiers.isEmpty && newlyLoadedImages.isEmpty {
                         imagePlaceholderView()
                    } else {
                        LazyVGrid(columns: imageGridColumns, spacing: 10) {
                            ForEach(existingImageIdentifiers, id: \.self) { id in
                                if let uiImage = ImageStore.shared.loadImage(withIdentifier: id) {
                                    imageThumbnailView(image: uiImage, onDelete: { deleteExistingImage(identifier: id) })
                                }
                            }
                            ForEach(newlyLoadedImages) { wrapped in
                                imageThumbnailView(image: wrapped.image, onDelete: { newlyLoadedImages.removeAll(where: { $0.id == wrapped.id }) })
                            }
                        }.padding(.vertical, 5)
                    }
                }
            }
            .navigationTitle("添加/编辑商品")
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) { Button("取消") { presentationMode.wrappedValue.dismiss() } }
                ToolbarItem(placement: .navigationBarTrailing) { Button("保存", action: saveAndDismiss).disabled(!isFormValid) }
                ToolbarItemGroup(placement: .keyboard) { Spacer(); Button("完成") { focusedField = nil } }
            }
            .onChange(of: selectedPhotoItems) { _, newItems in Task { await loadNewImages(from: newItems) } }
            .sheet(isPresented: $isPreviewingImage) { if let img = imageToPreview { FullScreenImageViewer(image: img) {} } }
        }
    }
    
    // MARK: - Views
    
    @ViewBuilder
    private func imageThumbnailView(image: UIImage, onDelete: @escaping () -> Void) -> some View {
        ZStack(alignment: .topTrailing) {
            Image(uiImage: image)
                .resizable().scaledToFill().frame(width: 100, height: 100)
                .cornerRadius(8).onTapGesture { self.imageToPreview = image; self.isPreviewingImage = true }
                .shadow(color: .black.opacity(0.2), radius: 2, y: 1)
            
            Button(action: onDelete) {
                Image(systemName: "xmark.circle.fill").font(.title2).symbolRenderingMode(.palette)
                    .foregroundStyle(.white, .red).shadow(color: .black.opacity(0.3), radius: 2, y: 1)
            }.buttonStyle(.plain).offset(x: 8, y: -8)
        }.frame(width: 100, height: 100)
    }
    
    private func imageSectionHeader() -> some View {
        HStack {
            Text("商品图片").font(.headline); Spacer()
            PhotosPicker(selection: $selectedPhotoItems, maxSelectionCount: 10, matching: .images) {
                Label("添加图片", systemImage: "plus.circle.fill")
            }.buttonStyle(.borderless)
        }
    }
    
    // <<< 最终修复点: 完全恢复您最初提供的、正确的代码实现 >>>
    @ViewBuilder
    private func imagePlaceholderView() -> some View {
        PhotosPicker(selection: $selectedPhotoItems, maxSelectionCount: 10, matching: .images) {
            VStack(spacing: 12) {
                Image(systemName: "photo.on.rectangle.angled").font(.system(size: 50))
                Text("添加商品图片").font(.headline)
            }
            .foregroundColor(.secondary)
            .frame(maxWidth: .infinity)
            .frame(height: 150)
            .contentShape(Rectangle())
            .background(
                RoundedRectangle(cornerRadius: 12)
                    .stroke(style: StrokeStyle(lineWidth: 2, dash: [8]))
                    .foregroundColor(Color.gray.opacity(0.5))
            )
        }
        .buttonStyle(.plain)
    }

    // MARK: - Logic
    private func saveAndDismiss() {
        item.unitPrice = Double(unitPriceString) ?? 0.0
        cleanupZeroQuantities()
        let newIdentifiers = newlyLoadedImages.compactMap { ImageStore.shared.saveImage($0.image) }
        let originalIdentifiers = Set(item.productImageIdentifiers)
        let finalKeptIdentifiers = Set(self.existingImageIdentifiers)
        let identifiersToDelete = Array(originalIdentifiers.subtracting(finalKeptIdentifiers))
        ImageStore.shared.deleteImages(withIdentifiers: identifiersToDelete)
        item.productImageIdentifiers = self.existingImageIdentifiers + newIdentifiers
        onSave(item)
        presentationMode.wrappedValue.dismiss()
    }
    private func deleteExistingImage(identifier: String) { existingImageIdentifiers.removeAll { $0 == identifier } }
    private func loadNewImages(from items: [PhotosPickerItem]) async {
        var loaded: [IdentifiableUIImage] = []
        for item in items { if let data = try? await item.loadTransferable(type: Data.self), let uiImage = UIImage(data: data) { loaded.append(IdentifiableUIImage(image: uiImage)) } }
        await MainActor.run { self.newlyLoadedImages.append(contentsOf: loaded); self.selectedPhotoItems.removeAll() }
    }
    private func toggleSizeSelection(_ size: String) { if item.sizeQuantities[size] != nil { item.sizeQuantities[size] = nil } else { item.sizeQuantities[size] = 1 } }
    private func quantityBinding(for size: String) -> Binding<String> { Binding<String>(get: { let q = self.item.sizeQuantities[size, default: 0]; return q > 0 ? String(q) : "" }, set: { str in if str.isEmpty { self.item.sizeQuantities[size] = 0 } else if let val = Int(str) { self.item.sizeQuantities[size] = val } }) }
    private func stepperBinding(for size: String) -> Binding<Int> { Binding<Int>(get: { self.item.sizeQuantities[size, default: 0] }, set: { val in if val <= 0 { self.item.sizeQuantities[size] = nil } else { self.item.sizeQuantities[size] = val } }) }
    private func cleanupZeroQuantities() { item.sizeQuantities = item.sizeQuantities.filter { $0.value > 0 } }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/OrderModels.swift
// ==========================================

// OrderModels.swift

import Foundation
import SwiftUI

// 新增: 物流状态枚举
enum ShipmentStatus: String, Codable, CaseIterable, Identifiable {
    case notShipped = "未寄出"
    case shipped = "已寄出"
    
    var id: Self { self }
    var displayTitle: String { self.rawValue }
}

// 新增: 商标选项
enum TrademarkOption: String, Codable, CaseIterable, Identifiable {
    case none = "无"
    case guestLabel = "客人标"
    
    var id: Self { self }
    var displayTitle: String { self.rawValue }
}

enum OrderUrgency: String, Codable, CaseIterable, Identifiable {
    case normal = "正常"
    case urgent = "加急"
    
    var id: Self { self }
    var displayTitle: String { self.rawValue }
}

enum ReworkReason: String, Codable, CaseIterable, Hashable, Identifiable {
    case wrongColor = "颜色错误", wrongSize = "尺码错误", wrongModel = "型号错误", wrongLeather = "皮料错误", qualityIssue = "质量问题", orderError = "订单填错", other = "其他"
    var id: Self { self }
    var displayTitle: String { self.rawValue }
}

struct ReworkItem: Identifiable, Codable, Hashable {
    // MARK: - 修复点 1: 将 let 改为 var
    var id = UUID(); var date: Date; var originalOrderItemID: UUID; var reasons: Set<ReworkReason>; var otherReasonDetail: String?; var reworkedItem: OrderItem
}

enum OrderStatus: String, Codable, CaseIterable {
    case active = "正常", refunded = "退货退款"
}

enum CustomerType: String, CaseIterable, Codable, Identifiable {
    case retail = "零售", wholesale = "批发"
    var id: Self { self }; var displayTitle: String { self.rawValue }
}

enum PaymentMethod: String, CaseIterable, Codable, Identifiable {
    case bankTransfer = "银行转账", wechat = "微信", alipay = "支付宝", cash = "现金", other = "其他"
    var id: Self { self }; var displayTitle: String { self.rawValue }
}

enum PaymentStatus: String, Codable {
    case pendingPrice = "单价待定", unpaid = "未收款", partial = "部分收款", paid = "已结清"
    var color: Color {
        switch self {
        case .pendingPrice, .unpaid: return .red
        case .partial: return .orange
        case .paid: return .green
        }
    }
}

struct Payment: Codable, Hashable, Identifiable, Equatable {
    // MARK: - 修复点 2: 将 let 改为 var
    var id = UUID(); var date: Date = Date(); var amount: Double = 0.0; var method: PaymentMethod = .other; var notes: String?
}

enum ProductType: String, Codable, CaseIterable, Identifiable {
    case custom = "定制", stock = "现货"
    var id: String { self.rawValue }
}

struct OrderItem: Codable, Identifiable, Hashable {
    var id = UUID(); var productName: String = ""; var color: String = ""; var leather: String = ""; var sizeQuantities: [String: Int] = [:]; var unitPrice: Double = 0.0; var productImageIdentifiers: [String] = []; var factoryOrderText: String?; var productType: ProductType?
    var totalItemQuantity: Int { sizeQuantities.values.reduce(0, +) }
    var totalItemPrice: Double { Double(totalItemQuantity) * unitPrice }
    init(id: UUID = UUID(), productName: String = "", color: String = "", leather: String = "", sizeQuantities: [String : Int] = [:], unitPrice: Double = 0.0, productImageIdentifiers: [String] = [], factoryOrderText: String? = nil, productType: ProductType? = .custom) {
        self.id = id; self.productName = productName; self.color = color; self.leather = leather; self.sizeQuantities = sizeQuantities; self.unitPrice = unitPrice; self.productImageIdentifiers = productImageIdentifiers; self.factoryOrderText = factoryOrderText; self.productType = productType
    }
}

struct Order: Codable, Identifiable, Hashable {
    var id = UUID()
    var orderNumber: String
    var customerName: String
    var date: Date
    var orderItems: [OrderItem]
    var urgency: OrderUrgency
    var customerType: CustomerType
    var trademark: TrademarkOption
    var shipmentStatus: ShipmentStatus
    var payments: [Payment] = []
    var status: OrderStatus? = .active
    var reworkItems: [ReworkItem] = []
    
    // 计算属性 (无变化)
    var totalOrderQuantity: Int { orderItems.reduce(0) { $0 + $1.totalItemQuantity } }
    var totalOrderPrice: Double { orderItems.reduce(0.0) { $0 + $1.totalItemPrice } }
    var paidAmount: Double { payments.reduce(0) { $0 + $1.amount } }
    var balanceDue: Double { let balance = totalOrderPrice - paidAmount; return balance < 0.001 ? 0 : balance }
    var paymentStatus: PaymentStatus { if hasPendingPrice { return .pendingPrice }; if paidAmount <= 0 { return .unpaid } else if balanceDue <= 0 { return .paid } else { return .partial } }
    var hasPendingPrice: Bool { orderItems.contains { $0.unitPrice <= 0 } }
    var previewImageIdentifiers: [String] { Array(orderItems.flatMap { $0.productImageIdentifiers }.prefix(4)) }
    static func == (lhs: Order, rhs: Order) -> Bool { lhs.id == rhs.id }
    func hash(into hasher: inout Hasher) { hasher.combine(id) }
    
    enum CodingKeys: String, CodingKey {
        case id, orderNumber, customerName, date, orderItems, urgency, customerType, trademark, shipmentStatus, payments, status, reworkItems
        case trackingNumber // 保留旧key用于解码
    }
    
    // 构造函数
    init(id: UUID = UUID(), orderNumber: String, customerName: String, date: Date, orderItems: [OrderItem], urgency: OrderUrgency, customerType: CustomerType, trademark: TrademarkOption, shipmentStatus: ShipmentStatus, payments: [Payment] = [], status: OrderStatus? = .active, reworkItems: [ReworkItem] = []) {
        self.id = id; self.orderNumber = orderNumber; self.customerName = customerName; self.date = date; self.orderItems = orderItems; self.urgency = urgency; self.customerType = customerType; self.trademark = trademark; self.shipmentStatus = shipmentStatus; self.payments = payments; self.status = status; self.reworkItems = reworkItems
    }

    // 自定义解码器
    init(from decoder: Decoder) throws {
        let container = try decoder.container(keyedBy: CodingKeys.self)
        id = try container.decodeIfPresent(UUID.self, forKey: .id) ?? UUID()
        orderNumber = try container.decode(String.self, forKey: .orderNumber)
        customerName = try container.decode(String.self, forKey: .customerName)
        date = try container.decode(Date.self, forKey: .date)
        orderItems = try container.decode([OrderItem].self, forKey: .orderItems)
        urgency = try container.decodeIfPresent(OrderUrgency.self, forKey: .urgency) ?? .normal
        customerType = try container.decodeIfPresent(CustomerType.self, forKey: .customerType) ?? .retail
        trademark = try container.decodeIfPresent(TrademarkOption.self, forKey: .trademark) ?? .none
        payments = try container.decodeIfPresent([Payment].self, forKey: .payments) ?? []
        status = try container.decodeIfPresent(OrderStatus.self, forKey: .status) ?? .active
        reworkItems = try container.decodeIfPresent([ReworkItem].self, forKey: .reworkItems) ?? []
        
        if let newStatus = try container.decodeIfPresent(ShipmentStatus.self, forKey: .shipmentStatus) {
            self.shipmentStatus = newStatus
        } else if let _ = try? container.decodeIfPresent(String.self, forKey: .trackingNumber) {
            self.shipmentStatus = .shipped
        } else {
            self.shipmentStatus = .shipped
        }
    }
    
    // MARK: - 修复点 3: 补上缺失的编码 (encode) 方法
    func encode(to encoder: Encoder) throws {
        var container = encoder.container(keyedBy: CodingKeys.self)
        try container.encode(id, forKey: .id)
        try container.encode(orderNumber, forKey: .orderNumber)
        try container.encode(customerName, forKey: .customerName)
        try container.encode(date, forKey: .date)
        try container.encode(orderItems, forKey: .orderItems)
        try container.encode(urgency, forKey: .urgency)
        try container.encode(customerType, forKey: .customerType)
        try container.encode(trademark, forKey: .trademark)
        try container.encode(shipmentStatus, forKey: .shipmentStatus) // 只编码新字段
        try container.encode(payments, forKey: .payments)
        try container.encode(status, forKey: .status)
        try container.encode(reworkItems, forKey: .reworkItems)
    }
}

struct OrderIDWrapper: Identifiable {
    let id: UUID
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/FactoryOrderRenderer.swift
// ==========================================

// FactoryOrderRenderer.swift
import SwiftUI

// --- 1. 仅用于渲染的 SwiftUI 视图模板 ---
struct FactoryOrderExportView: View {
    let order: Order
    let textContent: String
    
    private var allImageIds: [String] {
        order.orderItems.flatMap { $0.productImageIdentifiers }
    }
    
    var body: some View {
        VStack(alignment: .leading, spacing: 0) {
            ForEach(allImageIds, id: \.self) { imageId in
                if let uiImage = ImageStore.shared.loadImage(withIdentifier: imageId) {
                    Image(uiImage: uiImage)
                        .resizable()
                        .scaledToFit()
                }
            }
            
            Divider().padding(.vertical, 8)
            
            Text(textContent)
                .font(.body)
                .padding(.horizontal)
                .frame(maxWidth: .infinity, alignment: .leading)
        }
        .padding(.bottom)
        .frame(width: UIScreen.main.bounds.width)
        .background(Color.white)
    }
}


// --- 2. 图片生成器 ---
@MainActor
class FactoryOrderImageGenerator {
    static let shared = FactoryOrderImageGenerator()

    private init() {}
    
    func generate(for order: Order, textContent: String) -> UIImage? {
        let viewToRender = FactoryOrderExportView(order: order, textContent: textContent)
        
        let controller = UIHostingController(rootView: viewToRender)
        guard let view = controller.view else { return nil }
        
        let targetSize = view.intrinsicContentSize
        view.bounds = CGRect(origin: .zero, size: targetSize)
        view.backgroundColor = .clear

        let renderer = UIGraphicsImageRenderer(size: targetSize)
        let image = renderer.image { _ in
            view.drawHierarchy(in: view.bounds, afterScreenUpdates: true)
        }
        
        return image
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/OrderImageGenerator.swift
// ==========================================

// OrderImageGenerator.swift

import UIKit

class OrderImageGenerator {
    static let shared = OrderImageGenerator()
    private let renderWidth: CGFloat = 800
    private let padding: CGFloat = 30
    
    private let textFontSize: CGFloat = 64.0
    private let urgentTextFontSize: CGFloat = 76.0

    private init() {}
    
    func generate(for order: Order, productImages: [UIImage], textContent: String) -> UIImage? {
        guard let textImage = renderTextToImage(for: order, textContent: textContent) else {
            print("Error: Failed to render text to image.")
            return nil
        }
        
        return stitchImages(productImages: productImages, textImage: textImage)
    }

    private func renderTextToImage(for order: Order, textContent: String) -> UIImage? {
        // --- 准备样式 ---
        let normalParagraphStyle = NSMutableParagraphStyle()
        normalParagraphStyle.lineSpacing = 12
        
        let normalAttributes: [NSAttributedString.Key: Any] = [
            .font: UIFont(name: "PingFangSC-Regular", size: textFontSize) ?? UIFont.systemFont(ofSize: textFontSize),
            .paragraphStyle: normalParagraphStyle,
            .foregroundColor: UIColor.black
        ]
        
        let urgentAttributes: [NSAttributedString.Key: Any] = [
            .font: UIFont(name: "PingFangSC-Semibold", size: urgentTextFontSize) ?? UIFont.boldSystemFont(ofSize: urgentTextFontSize),
            .paragraphStyle: normalParagraphStyle,
            .foregroundColor: UIColor.red
        ]
        
        // --- 构建富文本 (NSMutableAttributedString) ---
        // 1. 先用普通样式创建整个文本
        let finalAttributedString = NSMutableAttributedString(string: textContent, attributes: normalAttributes)
        
        // 2. 如果是加急订单，在整个富文本中查找“订单加急！”并应用特殊样式
        if order.urgency == .urgent {
            let urgentText = "订单加急！"
            // 使用 NSString 的 range(of:) 方法来查找子字符串的位置
            let range = (textContent as NSString).range(of: urgentText)
            
            // 如果找到了匹配的范围
            if range.location != NSNotFound {
                // 在该范围上应用加急样式
                finalAttributedString.addAttributes(urgentAttributes, range: range)
            }
        }
        
        // --- 渲染图片 ---
        let textMaxWidth = renderWidth - (padding * 2)
        let textRect = finalAttributedString.boundingRect(with: CGSize(width: textMaxWidth, height: .greatestFiniteMagnitude), options: .usesLineFragmentOrigin, context: nil)
        let imageSize = CGSize(width: renderWidth, height: ceil(textRect.height) + (padding * 2))
        
        let renderer = UIGraphicsImageRenderer(size: imageSize)
        return renderer.image { context in
            UIColor.white.setFill()
            context.fill(CGRect(origin: .zero, size: imageSize))
            let borderPath = UIBezierPath(rect: CGRect(origin: .zero, size: imageSize))
            UIColor.black.setStroke()
            borderPath.lineWidth = 2.5
            borderPath.stroke()
            finalAttributedString.draw(in: CGRect(x: padding, y: padding, width: textMaxWidth, height: textRect.height))
        }
    }
    
    private func stitchImages(productImages: [UIImage], textImage: UIImage) -> UIImage? {
        let finalWidth = textImage.size.width
        let resizedProductImages = productImages.map { img -> UIImage in
            let scale = finalWidth / img.size.width
            let newHeight = img.size.height * scale
            let newSize = CGSize(width: finalWidth, height: newHeight)
            let renderer = UIGraphicsImageRenderer(size: newSize)
            return renderer.image { _ in img.draw(in: CGRect(origin: .zero, size: newSize)) }
        }
        let totalHeight = resizedProductImages.reduce(0) { $0 + $1.size.height } + textImage.size.height
        guard totalHeight > 0, finalWidth > 0 else { return nil }
        let finalSize = CGSize(width: finalWidth, height: totalHeight)
        let renderer = UIGraphicsImageRenderer(size: finalSize)
        return renderer.image { context in
            UIColor.white.setFill()
            context.fill(CGRect(origin: .zero, size: finalSize))
            var currentY: CGFloat = 0
            for image in resizedProductImages {
                image.draw(at: CGPoint(x: 0, y: currentY))
                currentY += image.size.height
            }
            textImage.draw(at: CGPoint(x: 0, y: currentY))
        }
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/AppDelegate.swift
// ==========================================


//AppDelegate

import UIKit

class AppDelegate: NSObject, UIApplicationDelegate {
    
    static var orientationLock = UIInterfaceOrientationMask.portrait

    func application(_ application: UIApplication, supportedInterfaceOrientationsFor window: UIWindow?) -> UIInterfaceOrientationMask {
        return AppDelegate.orientationLock
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/Date+Extensions.swift
// ==========================================

// Date+Extensions.swift

import Foundation

extension Date {
    /// 将日期格式化为 "yyyy年MM月dd日" 格式的字符串
    func formattedAsYMD() -> String {
        let formatter = DateFormatter()
        formatter.dateFormat = "yyyy年MM月dd日"
        formatter.locale = Locale(identifier: "zh_CN")
        return formatter.string(from: self)
    }

    /// 将日期格式化为 "yyyy/MM/dd" 格式的字符串
    func formattedAsYMDWithSlash() -> String {
        let formatter = DateFormatter()
        formatter.dateFormat = "yyyy/MM/dd"
        formatter.locale = Locale(identifier: "en_US_POSIX")
        return formatter.string(from: self)
    }
    
    func formattedAsShortDate() -> String {
        let formatter = DateFormatter()
        formatter.dateFormat = "MM/dd"
        return formatter.string(from: self)
    }
}

extension Collection {
    subscript(safe index: Index) -> Element? {
        return indices.contains(index) ? self[index] : nil
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/OrderItemExportView.swift
// ==========================================

// OrderItemExportView.swift

import SwiftUI

// 这个视图现在只用于渲染订单的“文字部分”
struct OrderItemExportView: View {
    let order: Order
    let item: OrderItem
    
    // 渲染宽度
    private let renderWidth: CGFloat = 800

    var body: some View {
        VStack(alignment: .leading, spacing: 18) {
            infoRow(label: "客户名称:", value: order.customerName)
            infoRow(label: "鞋子编号:", value: item.productName)
            infoRow(label: "颜色:", value: item.color)
            
            // <<< 核心修复点: 不再检查 orderNotes，而是检查 urgency >>>
            if order.urgency == .urgent {
                // 如果是加急订单，就显示一行 "订单类型: 加急"
                infoRow(label: "订单类型:", value: "加急")
            }
            
            infoRow(label: "对数和码数:", value: formatSizeQuantities(item.sizeQuantities))
            
            infoRow(label: "日期:", value: order.date.formattedAsYMD())
        }
        .font(.custom("PingFangSC-Medium", size: 32))
        .padding(30)
        .frame(width: renderWidth, alignment: .leading)
        .background(Color.white)
        .border(Color.black, width: 2.5)
    }
    
    @ViewBuilder
    private func infoRow(label: String, value: String) -> some View {
        HStack(alignment: .top) {
            Text(label)
                .frame(width: 240, alignment: .leading)
            Text(value)
                .frame(maxWidth: .infinity, alignment: .leading)
        }
    }
    
    private func formatSizeQuantities(_ quantities: [String: Int]) -> String {
        let sortedSizes = quantities.keys.sorted()
        return sortedSizes.map { size in
            let quantity = quantities[size] ?? 0
            let sizeNumber = size.replacingOccurrences(of: "码", with: "")
            return "\(quantity)/\(sizeNumber)"
        }.joined(separator: " ")
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/OrderViewModel.swift
// ==========================================

import Foundation
import SwiftUI

@MainActor
class OrderViewModel: ObservableObject {
    @Published var orders: [Order] = []
    @Published var deletedOrders: [Order] = []

    let ordersFileURL: URL
    let deletedOrdersFileURL: URL
    
    // 修改计算属性，只统计 active 状态的订单
    var totalRevenue: Double {
        orders.filter { $0.status ?? .active == .active }.reduce(0.0) { $0 + $1.totalOrderPrice }
    }
    
    var totalPaidAmount: Double {
        orders.filter { $0.status ?? .active == .active }.reduce(0.0) { $0 + $1.paidAmount }
    }
    
    var unconfirmedBalanceDue: Double {
        let balance = totalRevenue - totalPaidAmount
        return balance < 0.01 ? 0 : balance
    }

    init() {
        let documentsDirectory = FileManager.default.urls(for: .documentDirectory, in: .userDomainMask).first!
        ordersFileURL = documentsDirectory.appendingPathComponent("app_orders.json")
        deletedOrdersFileURL = documentsDirectory.appendingPathComponent("app_deleted_orders.json")
        migrateDataFromOldVersions(in: documentsDirectory)
        loadOrders()
        loadDeletedOrders()
    }
    
    private func migrateDataFromOldVersions(in directory: URL) {
        let oldOrdersFileURL = directory.appendingPathComponent("orders_v3.json")
        let fileManager = FileManager.default

        if !fileManager.fileExists(atPath: ordersFileURL.path) && fileManager.fileExists(atPath: oldOrdersFileURL.path) {
            do {
                try fileManager.moveItem(at: oldOrdersFileURL, to: ordersFileURL)
                let oldDeletedOrdersURL = directory.appendingPathComponent("deletedOrders_v3.json")
                if fileManager.fileExists(atPath: oldDeletedOrdersURL.path) {
                    try fileManager.moveItem(at: oldDeletedOrdersURL, to: deletedOrdersFileURL)
                }
            } catch {
                print("Error migrating data: \(error)")
            }
        }
    }

    func mergeImportedOrders(_ ordersToImport: [Order]) -> (importedCount: Int, skippedCount: Int) {
        let existingOrderIDs = Set(self.orders.map { $0.id })
        var newOrders: [Order] = []
        var skippedCount = 0
        
        for order in ordersToImport {
            if !existingOrderIDs.contains(order.id) {
                newOrders.append(order)
            } else {
                skippedCount += 1
            }
        }
        
        if !newOrders.isEmpty {
            self.orders.append(contentsOf: newOrders)
            self.orders.sort { $0.date > $1.date }
            Task { await self.saveOrders() }
        }
        
        return (newOrders.count, skippedCount)
    }
    
    // 实现订单状态更新方法
    func updateOrderStatus(for orderId: UUID, to newStatus: OrderStatus) {
        if let index = orders.firstIndex(where: { $0.id == orderId }) {
            orders[index].status = newStatus
            Task { await saveOrders() }
        }
    }
    
    @discardableResult
    func addOrder(_ order: Order) -> Order {
        var newOrder = order
        newOrder.orderNumber = OrderNumberGenerator.shared.generateNewOrderNumber(for: newOrder.date)
        
        orders.insert(newOrder, at: 0)
        Task { await saveOrders() }
        
        return newOrder
    }

    func updateOrder(_ updatedOrder: Order) {
        if let index = orders.firstIndex(where: { $0.id == updatedOrder.id }) {
            orders[index] = updatedOrder
            Task { await saveOrders() }
        }
    }

    func moveOrdersToTrash(ids: Set<UUID>) {
        let ordersToMove = orders.filter { ids.contains($0.id) }
        deletedOrders.insert(contentsOf: ordersToMove, at: 0)
        orders.removeAll { ids.contains($0.id) }
        Task {
            await saveOrders()
            await saveDeletedOrders()
        }
    }
    
    func moveOrderToTrash(id: UUID) {
        moveOrdersToTrash(ids: [id])
    }

    func restoreOrdersFromTrash(ids: Set<UUID>) {
        let ordersToRestore = deletedOrders.filter { ids.contains($0.id) }
        orders.insert(contentsOf: ordersToRestore, at: 0)
        orders.sort { $0.date > $1.date }
        deletedOrders.removeAll { ids.contains($0.id) }
        Task {
            await saveOrders()
            await saveDeletedOrders()
        }
    }

    func permanentlyDeleteOrdersFromTrash(ids: Set<UUID>) {
        let ordersToDelete = deletedOrders.filter { ids.contains($0.id) }
        for order in ordersToDelete {
            for item in order.orderItems {
                ImageStore.shared.deleteImages(withIdentifiers: item.productImageIdentifiers)
            }
        }
        deletedOrders.removeAll { ids.contains($0.id) }
        Task { await saveDeletedOrders() }
    }
    
    func removeOrdersPermanently(ids: Set<UUID>) {
        let ordersToRemove = orders.filter { ids.contains($0.id) }
        for order in ordersToRemove {
            for item in order.orderItems {
                ImageStore.shared.deleteImages(withIdentifiers: item.productImageIdentifiers)
            }
        }
        orders.removeAll { ids.contains($0.id) }
        Task { await saveOrders() }
    }
    
    // 确保加载时为旧数据设置默认状态
    func loadOrders() {
        do {
            let data = try Data(contentsOf: ordersFileURL)
            let decoder = JSONDecoder()
            var loadedOrders = try decoder.decode([Order].self, from: data)
            // 为没有 status 字段的旧数据设置默认值
            for i in 0..<loadedOrders.count {
                if loadedOrders[i].status == nil {
                    loadedOrders[i].status = .active
                }
            }
            orders = loadedOrders.sorted(by: { $0.date > $1.date })
        } catch {
            print("Could not load active orders: \(error)")
        }
    }

    func saveOrders() async {
        do {
            let encoder = JSONEncoder()
            encoder.outputFormatting = .prettyPrinted
            let data = try encoder.encode(orders)
            try data.write(to: ordersFileURL, options: .atomic)
        } catch {
            print("Could not save active orders: \(error)")
        }
    }
    
    func loadDeletedOrders() {
        do {
            let data = try Data(contentsOf: deletedOrdersFileURL)
            let decoder = JSONDecoder()
            deletedOrders = try decoder.decode([Order].self, from: data)
        } catch {
            print("Could not load deleted orders: \(error)")
        }
    }

    func saveDeletedOrders() async {
        do {
            let encoder = JSONEncoder()
            encoder.outputFormatting = .prettyPrinted
            let data = try encoder.encode(deletedOrders)
            try data.write(to: deletedOrdersFileURL, options: .atomic)
        } catch {
            print("Could not save deleted orders: \(error)")
        }
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/OrderNumberGenerator.swift
// ==========================================


//OrderNumberGenerator

import Foundation

class OrderNumberGenerator {
    
    static let shared = OrderNumberGenerator()

    private let userDefaults = UserDefaults.standard
    private let lastOrderDateKey = "lastOrderDate_v2" // 使用新key避免与旧数据冲突
    private let dailyCounterKey = "dailyCounter_v2"

    private init() {}

    // MARK: - 主要生成函数
    
    /// 为当天生成一个新的、递增的订单号。
    func generateNewOrderNumber() -> String {
        return generateNewOrderNumber(for: Date())
    }
    
    /// 为指定的日期生成一个新的订单号。
    /// 这个函数会检查并更新 UserDefaults，以确保同一天的订单号是连续的。
    func generateNewOrderNumber(for date: Date) -> String {
        let dateFormatter = DateFormatter()
        dateFormatter.dateFormat = "yyyyMMdd"
        
        let targetDateString = dateFormatter.string(from: date)
        let lastOrderDateString = userDefaults.string(forKey: lastOrderDateKey) ?? ""
        
        var currentCounter = userDefaults.integer(forKey: dailyCounterKey)

        if targetDateString == lastOrderDateString {
            // 如果是同一天，计数器加1
            currentCounter += 1
        } else {
            // 如果是新的一天，计数器重置为1
            currentCounter = 1
        }
        
        // 保存新的日期和计数器
        userDefaults.set(targetDateString, forKey: lastOrderDateKey)
        userDefaults.set(currentCounter, forKey: dailyCounterKey)
        
        // 格式化订单号，例如：20231027-001
        let formattedCounter = String(format: "%03d", currentCounter)
        return "\(targetDateString)-\(formattedCounter)"
    }

    // MARK: - 测试数据专用生成函数
    
    /// 为测试数据生成一个不依赖 UserDefaults 的订单号。
    /// - Parameters:
    ///   - date: 订单的日期。
    ///   - dailyCounter: 当天的序列号，以确保唯一性。
    func generateNewOrderNumber(for date: Date, dailyCounter: Int) -> String {
        let dateFormatter = DateFormatter()
        dateFormatter.dateFormat = "yyyyMMdd"
        let dateString = dateFormatter.string(from: date)
        
        // 直接使用传入的 dailyCounter，不与 UserDefaults 交互
        let formattedCounter = String(format: "%03d", dailyCounter + 1)
        return "\(dateString)-\(formattedCounter)"
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/ContentView.swift
// ==========================================

// ContentView.swift

import SwiftUI

// Helper enum for grouping orders by time period
private enum TimeCategory: Hashable, Comparable {
    case today, previous7Days, month(Date)
    
    static func < (lhs: TimeCategory, rhs: TimeCategory) -> Bool {
        switch (lhs, rhs) {
        case (.today, _): return false
        case (_, .today): return true
        case (.previous7Days, .month): return false
        case (.month, .previous7Days): return true
        case (.previous7Days, .previous7Days): return false
        case (.month(let d1), .month(let d2)): return d1 < d2
        }
    }
}

// Helper enum for the payment status filter menu
enum PaymentStatusFilter: String, CaseIterable, Identifiable {
    case all = "所有订单"
    case rework = "含返工"
    case pendingPrice = "单价待定"
    case unpaid = "未收款"
    case partial = "部分收款"
    case paid = "已结清"
    var id: String { self.rawValue }
}

struct ContentView: View {
    @EnvironmentObject var viewModel: OrderViewModel
    @EnvironmentObject var userSettings: UserSettings
    
    @State private var showingNewOrderSheet = false // 重命名以反映新视图
    @State private var selectedOrderID: OrderIDWrapper?
    
    @State private var searchText = ""
    
    @State private var showTrashViewSheet = false
    @State private var showingDatabaseView = false
    @State private var showingAnalyticsView = false
    @State private var showSideMenu = false
    @State private var menuOffset: CGFloat = 0
    @State private var showingCashConfirmationView = false
    @State private var isEditingForDelete = false
    @State private var selectedOrderIDs = Set<UUID>()
    @State private var showingDeleteConfirmationAlert = false
    @State private var galleryOrder: Order?
    @Namespace private var galleryNamespace
    
    @State private var paymentStatusFilter: PaymentStatusFilter = .all

    private var isEditing: Bool { isEditingForDelete }
    private var sideMenuWidth: CGFloat { UIScreen.main.bounds.width * 0.75 }
    private var menuAnimation: Animation { .interpolatingSpring(stiffness: 300, damping: 30) }

    // MARK: - Body
    
    var body: some View {
        GeometryReader { geometry in
            let screenWidth = geometry.size.width
            
            ZStack {
                mainContentView(screenWidth: screenWidth)
                    .offset(x: menuOffset)
                    .disabled(showSideMenu)
                    .scaleEffect(galleryOrder != nil ? 0.92 : 1.0)
                    .brightness(galleryOrder != nil ? -0.2 : 0)
                
                sideMenuView.offset(x: menuOffset - sideMenuWidth)
                
                if galleryOrder != nil {
                    ImageGalleryView(selectedOrder: $galleryOrder, namespace: galleryNamespace).zIndex(3)
                }
            }
            .animation(menuAnimation, value: menuOffset)
            .animation(.spring(response: 0.4, dampingFraction: 0.9), value: galleryOrder)
            .gesture(dragGestureToToggleMenu)
        }
    }

    // MARK: - Main Views
    
    private func mainContentView(screenWidth: CGFloat) -> some View {
        NavigationView {
            orderListView(screenWidth: screenWidth)
                .navigationBarTitleDisplayMode(.inline)
                .searchable(text: $searchText, prompt: "搜索客户、订单号或商品")
                .toolbar { mainToolbarContent }
        }
        // <<< 核心修改点: 使用 fullScreenCover 调用 NewOrderView >>>
        .fullScreenCover(isPresented: $showingNewOrderSheet) {
            NewOrderView().environmentObject(viewModel)
        }
        .sheet(item: $selectedOrderID) { wrapper in
            if let index = viewModel.orders.firstIndex(where: { $0.id == wrapper.id }) {
                NavigationView {
                    OrderDetailView(order: $viewModel.orders[index])
                }
                .environmentObject(viewModel)
                .environmentObject(userSettings)
            }
        }
        .sheet(isPresented: $showTrashViewSheet) { TrashView().environmentObject(viewModel) }
        .sheet(isPresented: $showingDatabaseView) { DatabaseView().environmentObject(viewModel) }
        .sheet(isPresented: $showingCashConfirmationView) { CashConfirmationView().environmentObject(viewModel) }
        .fullScreenCover(isPresented: $showingAnalyticsView) { AnalyticsView(orders: viewModel.orders) }
        .alert("确认操作", isPresented: $showingDeleteConfirmationAlert) {
            Button("移至垃圾桶", role: .destructive) { viewModel.moveOrdersToTrash(ids: selectedOrderIDs); cancelEditing() }
            Button("取消", role: .cancel) {}
        } message: { Text("你确定要将选中的 \(selectedOrderIDs.count) 个订单移至垃圾桶吗？") }
    }
    
    @ViewBuilder
    private func orderListView(screenWidth: CGFloat) -> some View {
        let currentGroupedOrders = groupedOrders(for: viewModel.orders)
        let ordersToDisplay = currentGroupedOrders.flatMap { $0.orders }

        if viewModel.orders.filter({ ($0.status ?? .active) == .active }).isEmpty {
            emptyStateView(message: "还没有订单 🧾\n点击右上角的 '+' 创建一个新订单吧！")
        } else if ordersToDisplay.isEmpty {
             emptyStateView(message: "没有符合筛选条件的订单")
        } else {
            List {
                ForEach(currentGroupedOrders, id: \.category) { group in
                    if !group.orders.isEmpty {
                        Section(header: Text(title(for: group.category))) {
                            ForEach(group.orders) { order in
                                savedOrderListRow(for: order, screenWidth: screenWidth)
                                    .opacity(galleryOrder?.id == order.id ? 0 : 1)
                                    .listRowSeparator(.hidden)
                                    .listRowInsets(EdgeInsets(top: 5, leading: 0, bottom: 5, trailing: 0))
                            }
                        }
                    }
                }
            }
            .listStyle(.plain)
            .id(userSettings.fontScaleMultiplier)
        }
    }
    
    // MARK: - Helper Views & Components
    
    @ToolbarContentBuilder
    private var mainToolbarContent: some ToolbarContent {
        ToolbarItem(placement: .principal) {
            HStack(spacing: 8) {
                Text("商家记账本").font(.headline)
                Menu {
                    Picker("筛选状态", selection: $paymentStatusFilter) {
                        ForEach(PaymentStatusFilter.allCases) { filter in Text(filter.rawValue).tag(filter) }
                    }
                } label: {
                    HStack(spacing: 4) {
                        Text(paymentStatusFilter.rawValue).font(.caption).foregroundColor(.accentColor)
                        Image(systemName: "chevron.down").font(.caption).foregroundColor(.accentColor)
                    }
                    .padding(.horizontal, 8).padding(.vertical, 4).background(Color.accentColor.opacity(0.1)).cornerRadius(8)
                }
            }
        }
        ToolbarItem(placement: .navigationBarLeading) {
            if isEditingForDelete { Button("取消") { cancelEditing() } }
            else { Button(action: { toggleSideMenu() }) { Image(systemName: "line.3.horizontal") } }
        }
        ToolbarItemGroup(placement: .navigationBarTrailing) {
            if isEditingForDelete {
                Button(action: { if !selectedOrderIDs.isEmpty { showingDeleteConfirmationAlert = true } }) {
                    Image(systemName: "trash")
                }.disabled(selectedOrderIDs.isEmpty)
            } else {
                // <<< 核心修改点: 按钮触发 showingNewOrderSheet >>>
                Button(action: { showingNewOrderSheet = true }) {
                    Image(systemName: "plus.circle.fill").imageScale(.large)
                }
            }
        }
    }
    
    @ViewBuilder
    private func savedOrderListRow(for order: Order, screenWidth: CGFloat) -> some View {
        ZStack(alignment: .topTrailing) {
            HStack(spacing: 12) {
                if isEditing {
                    Image(systemName: "checkmark.circle.fill")
                        .font(.title2).foregroundColor(selectedOrderIDs.contains(order.id) ? .accentColor : .secondary)
                        .frame(maxHeight: .infinity, alignment: .top).padding(.top, 10)
                }
                OrderRowView(
                    order: order,
                    screenWidth: screenWidth,
                    fontScaleMultiplier: userSettings.fontScaleMultiplier,
                    onImageTapped: { selectedOrder in self.galleryOrder = selectedOrder },
                    namespace: galleryNamespace
                )
                .padding(.horizontal)
            }
            .contentShape(Rectangle())
            .onTapGesture {
                if isEditing { toggleSelection(for: order) }
                else { selectedOrderID = OrderIDWrapper(id: order.id) }
            }
            .saturation( (order.status ?? .active) == .refunded ? 0 : 1)
            
            if let status = order.status, status == .refunded {
                statusTag(text: "退货退款", color: .white, backgroundColor: .gray)
                    .padding([.top, .trailing])
            } else if order.customerName.isEmpty {
                statusTag(text: "信息待补全", color: .white, backgroundColor: .red.opacity(0.8))
                    .padding([.top, .trailing])
            } else if order.hasPendingPrice {
                // 如果有待定价格，这里不显示Tag，让OrderRowView内部的红色文字来提示
            } else if order.paymentStatus != .unpaid {
                let status = order.paymentStatus
                statusTag(text: status.rawValue, color: .white, backgroundColor: status.color)
                    .padding([.top, .trailing])
            }
        }
        .matchedGeometryEffect(id: "row_\(order.id)", in: galleryNamespace, isSource: false)
        .contextMenu {
            if !isEditing {
                Button { selectedOrderID = OrderIDWrapper(id: order.id) } label: { Label("查看详情/编辑", systemImage: "doc.text.magnifyingglass") }
                if (order.status ?? .active) == .active {
                    Button(role: .destructive) { viewModel.updateOrderStatus(for: order.id, to: .refunded) } label: { Label("退货退款", systemImage: "arrow.uturn.backward.circle.fill") }
                } else {
                    Button { viewModel.updateOrderStatus(for: order.id, to: .active) } label: { Label("取消退货退款", systemImage: "arrow.uturn.forward.circle.fill") }
                }
                Divider()
                Button(role: .destructive) { viewModel.moveOrderToTrash(id: order.id) } label: { Label("移至垃圾桶", systemImage: "trash") }
            }
        }
    }
    
    @ViewBuilder
    private var sideMenuView: some View {
        if showSideMenu {
            Color.black.opacity(0.001).ignoresSafeArea().onTapGesture { toggleSideMenu() }.zIndex(1)
        }
        HStack {
            SideMenuView(showTrashView: $showTrashViewSheet, showSideMenu: $showSideMenu, showCashConfirmation: $showingCashConfirmationView, onToggleMultiSelectDelete: { self.isEditingForDelete.toggle(); if !self.isEditingForDelete { self.selectedOrderIDs.removeAll() }; self.toggleSideMenu() }, onShowDatabase: { self.showingDatabaseView = true }, onShowAnalytics: { self.showingAnalyticsView = true })
            .frame(width: self.sideMenuWidth).background(Color(.systemBackground)).transition(.move(edge: .leading))
            Spacer()
        }.zIndex(2).shadow(radius: showSideMenu ? 15 : 0)
    }

    @ViewBuilder
    private func emptyStateView(message: String) -> some View {
        VStack {
            Spacer()
            Text(message)
                .font(.title2)
                .multilineTextAlignment(.center)
                .foregroundColor(.gray)
                .padding()
            Spacer()
        }
        .frame(maxWidth: .infinity, maxHeight: .infinity)
    }
    
    // MARK: - Helper Functions
    
    private func groupedOrders(for orders: [Order]) -> [(category: TimeCategory, orders: [Order])] {
        let activeOrders = orders.filter { ($0.status ?? .active) == .active }
        
        let filteredByStatus: [Order]
        switch paymentStatusFilter {
        case .all:
            filteredByStatus = activeOrders
        case .rework:
            filteredByStatus = activeOrders.filter { !$0.reworkItems.isEmpty }
        case .pendingPrice:
            filteredByStatus = activeOrders.filter { $0.hasPendingPrice }
        case .unpaid:
            filteredByStatus = activeOrders.filter { !$0.hasPendingPrice && $0.paymentStatus == .unpaid }
        case .partial:
            filteredByStatus = activeOrders.filter { !$0.hasPendingPrice && $0.paymentStatus == .partial }
        case .paid:
            filteredByStatus = activeOrders.filter { !$0.hasPendingPrice && $0.paymentStatus == .paid }
        }
        
        let searchFiltered = filteredByStatus.filter { order in
            if searchText.isEmpty { return true }
            return order.customerName.localizedCaseInsensitiveContains(searchText) ||
                   order.orderNumber.localizedCaseInsensitiveContains(searchText) ||
                   order.orderItems.contains { $0.productName.localizedCaseInsensitiveContains(searchText) }
        }

        let grouped = Dictionary(grouping: searchFiltered, by: categorize)
        return grouped.keys.sorted(by: >).map { (category: $0, orders: grouped[$0]!) }
    }
    
    private func toggleSideMenu() {
        showSideMenu.toggle()
        menuOffset = showSideMenu ? sideMenuWidth : 0
    }

    private var dragGestureToToggleMenu: some Gesture {
        DragGesture()
            .onChanged { value in
                guard galleryOrder == nil, !isEditingForDelete else { return }
                let newOffset: CGFloat
                if showSideMenu { newOffset = sideMenuWidth + value.translation.width }
                else { guard value.startLocation.x < 50 else { return }; newOffset = value.translation.width }
                menuOffset = max(0, min(newOffset, sideMenuWidth))
            }
            .onEnded { value in
                guard galleryOrder == nil, !isEditingForDelete else { return }
                let velocity = value.predictedEndTranslation.width
                if (velocity > 200 && !showSideMenu) || (menuOffset > sideMenuWidth / 2 && velocity > -200) { showSideMenu = true }
                else { showSideMenu = false }
                menuOffset = showSideMenu ? sideMenuWidth : 0
            }
    }
    
    private func categorize(order: Order) -> TimeCategory {
        let now = Date(); let calendar = Calendar.current
        if calendar.isDateInToday(order.date) { return .today }
        if let sevenDaysAgo = calendar.date(byAdding: .day, value: -7, to: now), order.date >= sevenDaysAgo { return .previous7Days }
        let components = calendar.dateComponents([.year, .month], from: order.date)
        return .month(calendar.date(from: components)!)
    }
    
    private func title(for category: TimeCategory) -> String {
        switch category {
        case .today: return "今日"
        case .previous7Days: return "过去7日"
        case .month(let date):
            let formatter = DateFormatter(); formatter.locale = Locale(identifier: "zh_CN_POSIX"); formatter.dateFormat = "yyyy年M月"
            let thisMonthComponents = Calendar.current.dateComponents([.year, .month], from: Date())
            if Calendar.current.date(from: thisMonthComponents) == date { return "本月" }
            return formatter.string(from: date)
        }
    }
    
    private func cancelEditing() { isEditingForDelete = false; selectedOrderIDs.removeAll() }
    
    private func toggleSelection(for order: Order) {
        if selectedOrderIDs.contains(order.id) { selectedOrderIDs.remove(order.id) }
        else { selectedOrderIDs.insert(order.id) }
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/FontSizeModifier.swift
// ==========================================

import SwiftUI

// 回归到最简单的实现：接收一个具体的 size 值
struct ScaledFont: ViewModifier {
    let size: CGFloat
    
    func body(content: Content) -> some View {
        content.font(.system(size: size))
    }
}

extension View {
    // 扩展方法也回归简单
    func scaledFont(size: CGFloat) -> some View {
        self.modifier(ScaledFont(size: size))
    }
}

// 这个 Manager 保持不变，它的计算逻辑是正确的
struct FontSizeManager {
    static let baseScreenWidth: CGFloat = 390
    
    static func scaledSize(for style: Font.TextStyle, in screenWidth: CGFloat, multiplier: Double) -> CGFloat {
        let scale = screenWidth / baseScreenWidth
        let baseSize = UIFont.preferredFont(forTextStyle: style.toUIFontTextStyle()).pointSize
        return (baseSize * scale) * multiplier
    }
}

extension Font.TextStyle {
    func toUIFontTextStyle() -> UIFont.TextStyle {
        switch self {
        case .largeTitle: return .largeTitle
        case .title: return .title1
        case .title2: return .title2
        case .title3: return .title3
        case .headline: return .headline
        case .subheadline: return .subheadline
        case .body: return .body
        case .callout: return .callout
        case .footnote: return .footnote
        case .caption: return .caption1
        case .caption2: return .caption2
        @unknown default:
            return .body
        }
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/DatabaseView.swift
// ==========================================

// DatabaseView.swift

import SwiftUI

struct DatabaseView: View {
    @EnvironmentObject var viewModel: OrderViewModel
    @Environment(\.presentationMode) var presentationMode
    
    @State private var flatRecords: [FlatOrderRecord] = []
    
    // MARK: - 新增状态变量
    @State private var isShowingShareSheet = false
    @State private var csvFileURL: URL?
    
    // UI 定制区
    private let headers = ["订单编号", "日期", "客户", "客户类型", "订单类型", "商品编号", "颜色", "皮料", "尺码", "数量", "单价", "小计"]
    
    private let columnWidths: [CGFloat] = [
        180, // 订单编号
        120, // 日期
        130, // 客户
        100, // 客户类型
        100, // 订单类型
        160, // 商品编号
        110, // 颜色
        110, // 皮料
        80,  // 尺码
        80,  // 数量
        110, // 单价
        130, // 小计
    ]

    private let columnAlignments: [Alignment] = [
        .leading, .leading, .leading, .leading,
        .leading,
        .leading, .leading, .leading, .center, .trailing, .trailing, .trailing,
    ]
    
    var body: some View {
        NavigationView {
            ScrollView([.horizontal, .vertical], showsIndicators: true) {
                VStack(alignment: .leading, spacing: 0) {
                    LazyVGrid(columns: [GridItem()], pinnedViews: [.sectionHeaders]) {
                        Section(header: HeaderView(headers: headers, columnWidths: columnWidths, alignments: columnAlignments)) {
                            ForEach(flatRecords.indices, id: \.self) { index in
                                RowView(
                                    record: flatRecords[index],
                                    columnWidths: columnWidths,
                                    alignments: columnAlignments,
                                    backgroundColor: index % 2 == 0 ? Color(.systemBackground) : Color(.systemGray6)
                                )
                            }
                        }
                    }
                }
            }
            .background(Color(.systemGroupedBackground))
            .navigationTitle("数据库")
            .toolbar {
                // MARK: - 修改工具栏 (Toolbar)
                // 新增“导出”按钮，并保留原有的“关闭”按钮
                ToolbarItem(placement: .navigationBarLeading) {
                    Button(action: exportData) {
                        Label("导出Excel (CSV)", systemImage: "square.and.arrow.up")
                    }
                }
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("关闭") { presentationMode.wrappedValue.dismiss() }
                }
            }
            .onAppear(perform: flattenOrders)
            // MARK: - 新增 Sheet
            // 用于弹出分享菜单
            .sheet(isPresented: $isShowingShareSheet, onDismiss: cleanupCSVFile) {
                if let url = csvFileURL {
                    ShareSheet(activityItems: [url])
                }
            }
        }
    }
}

// MARK: - 新增的导出逻辑
private extension DatabaseView {
    
    /// 主导出函数，负责生成CSV文件并触发分享
    func exportData() {
        let csvString = generateCSVString()
        
        // 将CSV字符串保存到临时文件中
        let fileManager = FileManager.default
        let tempDir = fileManager.temporaryDirectory
        // 创建一个带时间戳的文件名
        let fileName = "数据库导出_\(Date().formattedAsYMDWithSlash().replacingOccurrences(of: "/", with: "-")).csv"
        let fileURL = tempDir.appendingPathComponent(fileName)

        do {
            // 使用UTF-8编码写入文件，以确保中文等字符正确显示
            try csvString.write(to: fileURL, atomically: true, encoding: .utf8)
            self.csvFileURL = fileURL
            self.isShowingShareSheet = true
        } catch {
            // 在实际应用中，这里可以添加一个Alert来提示用户导出失败
            print("创建CSV文件失败: \(error.localizedDescription)")
        }
    }

    /// 将扁平化的数据转换成一个完整的CSV格式字符串
    func generateCSVString() -> String {
        // 1. 创建表头行
        var csvText = headers.map { escapeCSVField($0) }.joined(separator: ",") + "\n"
        
        // 2. 遍历每一条记录，创建数据行
        for record in flatRecords {
            let rowData: [String] = [
                record.orderNumber,
                record.orderDate.formattedAsYMDWithSlash(),
                record.customerName,
                record.customerType,
                record.orderUrgency,
                record.productName,
                record.color,
                record.leather,
                record.size,
                "\(record.quantity)",
                String(format: "%.2f", record.unitPrice),
                String(format: "%.2f", record.itemTotalPrice)
            ]
            
            // 将每一行的数据拼接起来，并添加到总文本中
            let rowString = rowData.map { escapeCSVField($0) }.joined(separator: ",") + "\n"
            csvText.append(rowString)
        }
        
        return csvText
    }
    
    /// 处理单个字段，以符合CSV标准
    /// 如果字段中包含逗号、引号或换行符，就需要用双引号包裹起来。
    func escapeCSVField(_ field: String) -> String {
        // 先将字段内部的任何双引号替换为两个双引号
        let sanitizedField = field.replacingOccurrences(of: "\"", with: "\"\"")
        
        // 如果字段中包含逗号、换行符或原有的双引号，则整个字段需要用双引号包裹
        if sanitizedField.contains(",") || sanitizedField.contains("\n") || sanitizedField.contains("\"") {
            return "\"\(sanitizedField)\""
        }
        
        return sanitizedField
    }
    
    /// 分享结束后，清理临时文件
    func cleanupCSVFile() {
        if let url = csvFileURL {
            try? FileManager.default.removeItem(at: url)
            csvFileURL = nil
        }
    }
}


// 表头视图 (无需修改)
private struct HeaderView: View {
    let headers: [String]
    let columnWidths: [CGFloat]
    let alignments: [Alignment]
    
    var body: some View {
        HStack(spacing: 0) {
            ForEach(0..<headers.count, id: \.self) { index in
                Text(headers[index])
                    .font(.system(.subheadline, design: .monospaced).weight(.bold))
                    .foregroundColor(.secondary)
                    .padding(.horizontal, 10)
                    .padding(.vertical, 8)
                    .frame(width: columnWidths[index], alignment: .init(horizontal: alignments[index].horizontal, vertical: .center))
            }
        }
        .background(Color(.systemGray5))
        .overlay(Rectangle().frame(height: 1).foregroundColor(Color(.systemGray3)), alignment: .bottom)
    }
}

// 数据行视图 (无需修改)
private struct RowView: View {
    let record: FlatOrderRecord
    let columnWidths: [CGFloat]
    let alignments: [Alignment]
    let backgroundColor: Color
    
    var body: some View {
        HStack(spacing: 0) {
            cell(text: record.orderNumber, width: columnWidths[0], alignment: alignments[0]).fontWeight(.medium)
            cell(text: record.orderDate.formattedAsYMDWithSlash(), width: columnWidths[1], alignment: alignments[1])
            cell(text: record.customerName, width: columnWidths[2], alignment: alignments[2])
            cell(text: record.customerType, width: columnWidths[3], alignment: alignments[3])
            cell(text: record.orderUrgency, width: columnWidths[4], alignment: alignments[4])
            cell(text: record.productName, width: columnWidths[5], alignment: alignments[5])
            cell(text: record.color, width: columnWidths[6], alignment: alignments[6])
            cell(text: record.leather, width: columnWidths[7], alignment: alignments[7])
            cell(text: record.size, width: columnWidths[8], alignment: alignments[8])
            cell(text: "\(record.quantity)", width: columnWidths[9], alignment: alignments[9])
            cell(text: String(format: "%.2f", record.unitPrice), width: columnWidths[10], alignment: alignments[10])
            cell(text: String(format: "%.2f", record.itemTotalPrice), width: columnWidths[11], alignment: alignments[11]).foregroundColor(.blue)
        }
        .background(backgroundColor)
    }
    
    private func cell(text: String, width: CGFloat, alignment: Alignment) -> some View {
        Text(text)
            .font(.system(.footnote, design: .monospaced))
            .padding(.horizontal, 10)
            .padding(.vertical, 12)
            .frame(width: width, alignment: alignment)
            .lineLimit(1)
            .truncationMode(.tail)
    }
}

// flattenOrders 逻辑 (无需修改)
extension DatabaseView {
    private func flattenOrders() {
        var records: [FlatOrderRecord] = []
        let sortedOrders = viewModel.orders.sorted { $0.date > $1.date }
        
        for order in sortedOrders {
            for item in order.orderItems {
                let sortedSizes = item.sizeQuantities.keys.sorted()
                for size in sortedSizes {
                    if let quantity = item.sizeQuantities[size], quantity > 0 {
                        let record = FlatOrderRecord(
                            orderNumber: order.orderNumber,
                            orderDate: order.date,
                            customerName: order.customerName,
                            customerType: order.customerType.displayTitle,
                            orderUrgency: order.urgency.displayTitle,
                            productName: item.productName,
                            color: item.color,
                            leather: item.leather,
                            size: size,
                            quantity: quantity,
                            unitPrice: item.unitPrice
                        )
                        records.append(record)
                    }
                }
            }
        }
        self.flatRecords = records
    }
}

// Alignment 扩展 (无需修改)
extension Alignment {
    var horizontal: HorizontalAlignment {
        switch self {
        case .leading: return .leading
        case .center: return .center
        case .trailing: return .trailing
        default: return .leading
        }
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/ShareSheet.swift
// ==========================================

// ShareSheet.swift
import SwiftUI

struct ShareSheet: UIViewControllerRepresentable {
    var activityItems: [Any]
    var applicationActivities: [UIActivity]? = nil

    func makeUIViewController(context: Context) -> UIActivityViewController {
        let controller = UIActivityViewController(
            activityItems: activityItems,
            applicationActivities: applicationActivities
        )
        return controller
    }

    func updateUIViewController(_ uiViewController: UIActivityViewController, context: Context) {}
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/AnalyticsViewModel.swift
// ==========================================

import SwiftUI
import Combine

struct BusinessSummaryData {
    var revenue: Double = 0
    var orderCount: Int = 0
    var unitsSold: Int = 0
    var customerCount: Int = 0
    var previousRevenue: Double?
    var previousOrderCount: Int?
    var previousUnitsSold: Int?
    var previousCustomerCount: Int?
    
    var revenueChange: Double? { guard let p = previousRevenue, p != 0 else { return nil }; return (revenue - p) / p }
    var orderCountChange: Double? { guard let p = previousOrderCount, p != 0 else { return nil }; return (Double(orderCount - p) / Double(p)) }
    var unitsSoldChange: Double? { guard let p = previousUnitsSold, p != 0 else { return nil }; return (Double(unitsSold - p) / Double(p)) }
    var customerCountChange: Double? { guard let p = previousCustomerCount, p != 0 else { return nil }; return (Double(customerCount - p) / Double(p)) }
}

struct ChartSegment: Identifiable {
    let id: Date
    var date: Date
    var totalValue: Double
    var retailValue: Double
    var wholesaleValue: Double
    var orderCount: Int
    var unitCount: Int
    var retailOrderCount: Int
    var wholesaleOrderCount: Int
}

struct ProductAnalysisData: Identifiable {
    let id: String
    let productName: String
    var totalQuantity: Int
    var totalRevenue: Double
    init(id: String, productName: String, totalQuantity: Int = 0, totalRevenue: Double = 0.0) {
        self.id = id; self.productName = productName; self.totalQuantity = totalQuantity; self.totalRevenue = totalRevenue
    }
}

struct SizeRankData: Identifiable, Hashable { let id: String; let size: String; var quantity: Int }
struct ColorRankData: Identifiable, Hashable { let id: String; let color: String; var quantity: Int }
struct CustomerAnalysisData: Identifiable { let id = UUID(); let customerName: String; var monthlyData: [MonthlyCustomerData] }
struct MonthlyCustomerData: Identifiable, Hashable { let id: String; let month: Date; var orderCount: Int; var unitsSold: Int; var revenue: Double; var topProducts: [String] }


@MainActor
class AnalyticsViewModel: ObservableObject {
    
    enum TimeGranularity: String, CaseIterable, Identifiable {
        case day = "按日"
        case week = "按周"
        case month = "按月"
        case quarter = "按季度"
        case year = "按年"
        var id: String { self.rawValue }
        
        var calendarComponent: Calendar.Component {
            switch self {
            case .day: return .day
            case .week: return .weekOfYear
            case .month: return .month
            case .quarter: return .quarter
            case .year: return .year
            }
        }
    }
    
    enum ComparisonType: String, CaseIterable, Identifiable { case none = "当前数据", periodOverPeriod = "环比", yearOverYear = "同比"; var id: String { self.rawValue } }
    
    @Published var granularity: TimeGranularity = .day
    @Published var selectedDate: Date = .now
    @Published var customDateRange: ClosedRange<Date>? = nil
    @Published var customerType: CustomerType? = nil
    @Published var comparisonType: ComparisonType = .none
    
    @Published var summaryData = BusinessSummaryData()
    @Published var chartData: [ChartSegment] = []
    
    @Published var productAnalysisByRevenue: [ProductAnalysisData] = []
    @Published var productAnalysisByQuantity: [ProductAnalysisData] = []
    @Published var sizeRanking: [SizeRankData] = []
    @Published var colorRanking: [ColorRankData] = []
    
    @Published var customerAnalysis: [CustomerAnalysisData] = []
    @Published var selectedCustomerName: String? = nil
    @Published var customerSummaryData = BusinessSummaryData()
    
    var wholesaleCustomerNames: [String] { Set(allOrders.filter { $0.customerType == .wholesale }.map { $0.customerName }).sorted() }
    
    var selectedDateLabel: String {
        if let range = customDateRange { let formatter = DateFormatter(); formatter.dateFormat = "yyyy.MM.dd"; return "\(formatter.string(from: range.lowerBound)) - \(formatter.string(from: range.upperBound))" }
        let calendar = Calendar.current; let today = Date.now
        switch granularity {
        case .day: if calendar.isDateInToday(selectedDate) { return "今天" }; if calendar.isDateInYesterday(selectedDate) { return "昨天" }; return selectedDate.formatted(.dateTime.year().month().day())
        case .week: if calendar.isDate(selectedDate, equalTo: today, toGranularity: .weekOfYear) { return "本周" }; if let lastWeek = calendar.date(byAdding: .weekOfYear, value: -1, to: today), calendar.isDate(selectedDate, equalTo: lastWeek, toGranularity: .weekOfYear) { return "上周" }; let weekInterval = calendar.dateInterval(of: .weekOfYear, for: selectedDate)!; let start = weekInterval.start.formatted(.dateTime.month().day()); let end = weekInterval.end.addingTimeInterval(-1).formatted(.dateTime.month().day()); return "\(start) - \(end)"
        case .month: if calendar.isDate(selectedDate, equalTo: today, toGranularity: .month) { return "\(selectedDate.formatted(.dateTime.year().month())) (本月)" }; return selectedDate.formatted(.dateTime.year().month())
        case .quarter: let year = selectedDate.formatted(.dateTime.year()); let quarter = (Calendar.current.component(.month, from: selectedDate) - 1) / 3 + 1; return "\(year) Q\(quarter)"
        case .year: if calendar.isDate(selectedDate, equalTo: today, toGranularity: .year) { return "\(selectedDate.formatted(.dateTime.year())) (本年)"}; return selectedDate.formatted(.dateTime.year())
        }
    }
    
    private var allOrders: [Order]
    private var cancellables = Set<AnyCancellable>()

    init(orders: [Order]) {
        // 在初始化时，就过滤掉所有已退款的订单
        self.allOrders = orders.filter { $0.status ?? .active == .active }
        
        let trigger = PassthroughSubject<Void, Never>()
        $granularity.sink { _ in trigger.send() }.store(in: &cancellables)
        $selectedDate.sink { _ in trigger.send() }.store(in: &cancellables)
        $customDateRange.sink { _ in trigger.send() }.store(in: &cancellables)
        $customerType.sink { _ in trigger.send() }.store(in: &cancellables)
        $comparisonType.sink { _ in trigger.send() }.store(in: &cancellables)
        $selectedCustomerName.sink { _ in trigger.send() }.store(in: &cancellables)
        trigger.debounce(for: .milliseconds(100), scheduler: DispatchQueue.main).sink { [weak self] in self?.calculateAllData() }.store(in: &cancellables)
        calculateAllData()
    }
    
    func moveToNextPeriod() {
        let component: Calendar.Component = { switch self.granularity { case .day: return .day; case .week: return .weekOfYear; case .month: return .month; case .quarter: return .month; case .year: return .year } }()
        let value = (granularity == .quarter) ? 3 : 1
        if let nextDate = Calendar.current.date(byAdding: component, value: value, to: selectedDate) { selectedDate = nextDate }
    }
    
    func moveToPreviousPeriod() {
        let component: Calendar.Component = { switch self.granularity { case .day: return .day; case .week: return .weekOfYear; case .month: return .month; case .quarter: return .month; case .year: return .year } }()
        let value = (granularity == .quarter) ? -3 : -1
        if let prevDate = Calendar.current.date(byAdding: component, value: value, to: selectedDate) { selectedDate = prevDate }
    }
    
    private func calculateAllData() {
        let (currentRange, previousRange) = getDateRangesForKPIs()
        let kpiOrders = filterOrders(in: currentRange)
        calculateBusinessSummary(currentOrders: kpiOrders, previousRange: previousRange)
        calculateProductAnalysis(orders: kpiOrders)
        calculateCustomerAnalysis()
        generateChartData(for: granularity)
    }

    private func calculateBusinessSummary(currentOrders: [Order], previousRange: DateInterval?) {
        let currentSummary = calculateSummary(for: currentOrders)
        if comparisonType != .none, let prevRange = previousRange {
            let previousOrders = filterOrders(in: prevRange); let previousSummary = calculateSummary(for: previousOrders)
            summaryData = BusinessSummaryData(revenue: currentSummary.revenue, orderCount: currentSummary.orderCount, unitsSold: currentSummary.unitsSold, customerCount: currentSummary.customerCount, previousRevenue: previousSummary.revenue, previousOrderCount: previousSummary.orderCount, previousUnitsSold: previousSummary.unitsSold, previousCustomerCount: previousSummary.customerCount)
        } else { summaryData = currentSummary }
    }
    
    private func calculateProductAnalysis(orders: [Order]) {
        var productDict: [String: ProductAnalysisData] = [:]; var sizeDict: [String: Int] = [:]; var colorDict: [String: Int] = [:]
        for order in orders { for item in order.orderItems {
            var product = productDict[item.productName, default: ProductAnalysisData(id: item.productName, productName: item.productName)]; product.totalQuantity += item.totalItemQuantity; product.totalRevenue += item.totalItemPrice; productDict[item.productName] = product
            colorDict[item.color, default: 0] += item.totalItemQuantity
            for (size, quantity) in item.sizeQuantities { sizeDict[size, default: 0] += quantity }
        }}
        
        self.productAnalysisByRevenue = productDict.values.sorted { $0.totalRevenue > $1.totalRevenue }
        self.productAnalysisByQuantity = productDict.values.sorted { $0.totalQuantity > $1.totalQuantity }
        self.colorRanking = colorDict.map { ColorRankData(id: $0.key, color: $0.key, quantity: $0.value) }.sorted { $0.quantity > $1.quantity }
        self.sizeRanking = sizeDict.map { SizeRankData(id: $0.key, size: $0.key, quantity: $0.value) }.sorted { $0.quantity > $1.quantity }
    }
    
    private func calculateCustomerAnalysis() {
        let wholesaleOrders = allOrders.filter { $0.customerType == .wholesale }
        let customerOrders: [Order] = selectedCustomerName != nil ? wholesaleOrders.filter { $0.customerName == selectedCustomerName } : wholesaleOrders
        self.customerSummaryData = calculateSummary(for: customerOrders)
        
        let groupedByCustomer = Dictionary(grouping: wholesaleOrders, by: { $0.customerName }); let monthFormatter = DateFormatter(); monthFormatter.dateFormat = "yyyy-MM"; var finalAnalysis: [CustomerAnalysisData] = []
        for (name, orders) in groupedByCustomer {
            let groupedByMonth = Dictionary(grouping: orders, by: { monthFormatter.string(from: $0.date) }); var monthlyDataList: [MonthlyCustomerData] = []
            for (monthStr, monthOrders) in groupedByMonth {
                var productTally: [String: Int] = [:]; for order in monthOrders { for item in order.orderItems { productTally[item.productName, default: 0] += item.totalItemQuantity } }
                if let monthDate = monthFormatter.date(from: monthStr) {
                    monthlyDataList.append(MonthlyCustomerData(id: monthStr, month: monthDate, orderCount: monthOrders.count, unitsSold: monthOrders.reduce(0){$0 + $1.totalOrderQuantity}, revenue: monthOrders.reduce(0){$0 + $1.totalOrderPrice}, topProducts: productTally.sorted{$0.value > $1.value}.prefix(3).map{$0.key}))
                }
            }
            finalAnalysis.append(CustomerAnalysisData(customerName: name, monthlyData: monthlyDataList.sorted{$0.month > $1.month}))
        }
        self.customerAnalysis = finalAnalysis.sorted{$0.customerName < $1.customerName}
    }

    private func generateChartData(for granularity: TimeGranularity) {
        let calendar = Calendar.current
        let components: Set<Calendar.Component>
        
        switch granularity {
        case .day:
            components = [.year, .month, .day]
        case .week:
            components = [.yearForWeekOfYear, .weekOfYear]
        case .month:
            components = [.year, .month]
        case .quarter:
            components = [.year, .quarter]
        case .year:
            components = [.year]
        }
        
        let ordersForChart = allOrders
        
        guard !ordersForChart.isEmpty else {
            self.chartData = []
            return
        }

        let groupedOrders = Dictionary(grouping: ordersForChart) { order in
            let dateComponents = calendar.dateComponents(components, from: order.date)
            return calendar.date(from: dateComponents) ?? calendar.startOfDay(for: order.date)
        }
        
        var aggregatedData: [ChartSegment] = []
        
        for (date, orders) in groupedOrders {
            let totalValue = orders.reduce(0) { $0 + $1.totalOrderPrice }
            let unitCount = orders.reduce(0) { $0 + $1.totalOrderQuantity }
            
            let retailOrders = orders.filter { $0.customerType == .retail }
            let wholesaleOrders = orders.filter { $0.customerType == .wholesale }
            
            let retailValue = retailOrders.reduce(0) { $0 + $1.totalOrderPrice }
            let wholesaleValue = wholesaleOrders.reduce(0) { $0 + $1.totalOrderPrice }
            
            let segment = ChartSegment(
                id: date,
                date: date,
                totalValue: totalValue,
                retailValue: retailValue,
                wholesaleValue: wholesaleValue,
                orderCount: orders.count,
                unitCount: unitCount,
                retailOrderCount: retailOrders.count,
                wholesaleOrderCount: wholesaleOrders.count
            )
            aggregatedData.append(segment)
        }
        
        self.chartData = aggregatedData.sorted { $0.date < $1.date }
    }
    
    private func getDateRangesForKPIs() -> (DateInterval, DateInterval?) {
        if let customRange = customDateRange {
            let endOfDay = Calendar.current.startOfDay(for: customRange.upperBound).addingTimeInterval(24 * 60 * 60 - 1)
            return (DateInterval(start: customRange.lowerBound, end: endOfDay), nil)
        }
        
        let component: Calendar.Component = granularity.calendarComponent
        if component == .day { // Day logic is simpler
            let dayInterval = Calendar.current.dateInterval(of: .day, for: selectedDate)!
            var previousRange: DateInterval? = nil
            if comparisonType == .periodOverPeriod, let prevDate = Calendar.current.date(byAdding: .day, value: -1, to: selectedDate) {
                previousRange = Calendar.current.dateInterval(of: .day, for: prevDate)
            }
            if comparisonType == .yearOverYear, let prevDate = Calendar.current.date(byAdding: .year, value: -1, to: selectedDate) {
                previousRange = Calendar.current.dateInterval(of: .day, for: prevDate)
            }
            return (dayInterval, previousRange)
        }
        
        let calendar = Calendar.current
        guard let currentRange = calendar.dateInterval(of: component, for: selectedDate) else { return (DateInterval(), nil) }
        
        var previousRange: DateInterval? = nil
        if comparisonType == .periodOverPeriod {
            let moveValue = (component == .quarter) ? -3 : -1
            let componentToMove = (component == .quarter) ? .month : component
            if let prevDate = calendar.date(byAdding: componentToMove, value: moveValue, to: selectedDate) {
                previousRange = calendar.dateInterval(of: component, for: prevDate)
            }
        } else if comparisonType == .yearOverYear {
            if let prevDate = calendar.date(byAdding: .year, value: -1, to: selectedDate) {
                previousRange = calendar.dateInterval(of: component, for: prevDate)
            }
        }
        
        return (currentRange, previousRange)
    }

    private func filterOrders(in interval: DateInterval) -> [Order] {
        allOrders.filter { interval.contains($0.date) && (customerType == nil || $0.customerType == customerType) }
    }
    
    private func calculateSummary(for orders: [Order]) -> BusinessSummaryData {
        BusinessSummaryData(revenue: orders.reduce(0, {$0 + $1.totalOrderPrice}), orderCount: orders.count, unitsSold: orders.reduce(0, {$0 + $1.totalOrderQuantity}), customerCount: Set(orders.map({$0.customerName})).count)
    }
}


// ==========================================
// 文件路径: /Users/david/Desktop/商家账单副本/商家账单/TestDataManager.swift
// ==========================================

// TestDataManager.swift

import Foundation

class TestDataManager {
    
    @MainActor
    static func generateTestData(for viewModel: OrderViewModel) {
        // 先清空现有数据，避免重复生成
        deleteAllData(for: viewModel)
        
        let sampleProductNames = ["经典款小白鞋", "复古德训鞋", "厚底老爹鞋", "帆布板鞋", "切尔西短靴", "乐福鞋"]
        let sampleColors = ["白色", "黑色", "米白", "燕麦色", "卡其色", "银色"]
        let sampleLeathers = ["牛皮", "羊皮", "帆布", "麂皮"]
        let allSizes = (35...42).map { "\($0)码" }
        
        let wholesaleCustomers = ["广州大客户", "深圳张小姐", "杭州批发商", "北京潮流店"]
        let retailCustomers = ["李女士", "王先生", "小红薯用户", "VIP客户-赵"]
        
        var generatedOrders: [Order] = []
        let calendar = Calendar.current
        let startDate = calendar.date(from: DateComponents(year: 2024, month: 1, day: 1))!
        let endDate = Date.now
        
        for i in 0..<100 {
            let randomTimeInterval = TimeInterval.random(in: startDate.timeIntervalSince1970...endDate.timeIntervalSince1970)
            let randomDate = Date(timeIntervalSince1970: randomTimeInterval)
            let customerType: CustomerType = Bool.random() ? .wholesale : .retail
            let customerName = customerType == .wholesale ? wholesaleCustomers.randomElement()! : retailCustomers.randomElement()!
            var orderItems: [OrderItem] = []
            for _ in 0..<Int.random(in: 1...3) {
                var sizeQuantities: [String: Int] = [:]; for _ in 0..<Int.random(in: 2...5) { sizeQuantities[allSizes.randomElement()!] = Int.random(in: 1...5) }
                let item = OrderItem(productName: sampleProductNames.randomElement()! + "-\(Int.random(in: 100...999))", color: sampleColors.randomElement()!, leather: sampleLeathers.randomElement()!, sizeQuantities: sizeQuantities, unitPrice: Double(Int.random(in: 200...800)))
                orderItems.append(item)
            }
            
            // MARK: - 核心修复点: 移除重复的 'trademark' 参数
            let newOrder = Order(
                orderNumber: OrderNumberGenerator.shared.generateNewOrderNumber(for: randomDate, dailyCounter: i),
                customerName: customerName,
                date: randomDate,
                orderItems: orderItems,
                urgency: OrderUrgency.allCases.randomElement() ?? .normal,
                customerType: customerType,
                trademark: TrademarkOption.allCases.randomElement() ?? .none, // <-- 只保留这一行
                shipmentStatus: ShipmentStatus.allCases.randomElement() ?? .notShipped
            )
            generatedOrders.append(newOrder)
        }
        
        viewModel.orders.insert(contentsOf: generatedOrders, at: 0)
        viewModel.orders.sort { $0.date > $1.date }
        
        Task {
            await viewModel.saveOrders()
        }
    }
    
    @MainActor
    static func deleteAllData(for viewModel: OrderViewModel) {
        for order in viewModel.orders { for item in order.orderItems { ImageStore.shared.deleteImages(withIdentifiers: item.productImageIdentifiers) } }
        for order in viewModel.deletedOrders { for item in order.orderItems { ImageStore.shared.deleteImages(withIdentifiers: item.productImageIdentifiers) } }
        
        viewModel.orders.removeAll()
        viewModel.deletedOrders.removeAll()
        
        Task {
            await viewModel.saveOrders()
            await viewModel.saveDeletedOrders()
        }
    }
}
